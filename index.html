<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>G-COMMANDER V6.1 | FINAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', -apple-system, sans-serif; background: #f0f2f5; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .hidden-section { display: none !important; }
        .active-btn { background: #4f46e5 !important; color: white !important; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <nav class="bg-indigo-600 text-white p-4 shadow-xl flex justify-between items-center z-50">
        <div class="flex items-center space-x-3">
            <span class="font-black text-2xl tracking-tighter cursor-pointer" onclick="location.reload()">G-COMMANDER</span>
            <span class="text-[10px] bg-indigo-500 px-2 py-0.5 rounded-full font-bold">V6.1 FINAL</span>
        </div>
        <div class="flex space-x-6 text-sm font-black">
            <button onclick="toggleModal('sbModal')" class="hover:text-indigo-200">â˜ ï¸ é¡½å›º <span id="navSb" class="bg-slate-800 px-1.5 rounded ml-1">0</span></button>
            <button onclick="toggleModal('nbModal')" class="hover:text-indigo-200">ğŸ“• ç”Ÿè¯ <span id="navNb" class="bg-white text-indigo-600 px-1.5 rounded ml-1">0</span></button>
        </div>
    </nav>

    <main class="flex-grow overflow-y-auto p-6 md:p-12 flex flex-col items-center">
        
        <div id="homeSection" class="w-full max-w-5xl space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-gradient-to-br from-indigo-600 to-purple-700 p-10 rounded-[3rem] text-white shadow-2xl flex flex-col justify-between border-b-8 border-indigo-800">
                    <div>
                        <p class="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">JLPT 2026 Battle</p>
                        <div class="text-8xl font-black mb-6" id="countdown">---</div>
                        <p class="text-sm italic border-l-2 border-indigo-400 pl-4 py-1" id="motto">"æ‰§è¡Œç›®æ ‡ï¼Œè€Œä¸æ˜¯ä¸€ç›´åœ¨è®¡åˆ’ã€‚"</p>
                    </div>
                    <div class="mt-8 bg-black/20 p-4 rounded-2xl">
                        <p class="text-[10px] font-black mb-1 uppercase text-indigo-200">ä»Šæ—¥ç†æ€§å»ºè®®</p>
                        <p id="todayTip" class="text-xs font-bold leading-relaxed">å±è”½æƒ…ç»ªè¯¯å¯¼ï¼Œç”¨ç†æ€§æ¥çœ‹å¾…æ‰€æœ‰äº‹æƒ…ã€‚</p>
                    </div>
                </div>

                <div class="bg-white p-10 rounded-[3rem] shadow-xl border border-slate-100 flex flex-col">
                    <h3 class="font-black text-xl mb-6">é…ç½®ä»»åŠ¡ç¯å¢ƒ</h3>
                    
                    <div class="mb-6 space-y-3">
                        <label class="text-[10px] font-black text-slate-400 uppercase">è®­ç»ƒå¼ºåº¦</label>
                        <div class="flex space-x-2">
                            <button id="modeQuick" onclick="setMode('quick')" class="flex-1 py-3 rounded-xl font-bold text-sm bg-slate-100 transition">æé€Ÿæ¨¡å¼</button>
                            <button id="modeDeep" onclick="setMode('deep')" class="flex-1 py-3 rounded-xl font-bold text-sm bg-slate-100 transition">æ·±åº¦æ¨¡å¼</button>
                        </div>
                    </div>

                    <div id="resumeBox" class="hidden-section mb-6 p-4 bg-amber-50 border border-amber-100 rounded-2xl flex justify-between items-center">
                        <span id="resumeInfo" class="text-[10px] font-black text-amber-600">å‘ç°æœªå®Œæˆè¿›åº¦</span>
                        <button onclick="resumeStudy()" class="text-[10px] font-black bg-amber-500 text-white px-3 py-1.5 rounded-lg">ç»§ç»­æ‰§è¡Œ</button>
                    </div>

                    <label class="flex-grow flex flex-col items-center justify-center border-4 border-dashed border-slate-100 rounded-[2.5rem] hover:border-indigo-400 transition cursor-pointer p-8">
                        <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls" />
                        <span class="text-5xl mb-3">ğŸ“‚</span>
                        <span class="font-black text-slate-800">å¯¼å…¥ 805 è¯è¡¨</span>
                    </label>
                </div>
            </div>
        </div>

        <div id="studySection" class="hidden-section w-full max-w-xl">
            <div class="flex justify-between items-center mb-6">
                <button onclick="location.reload()" class="bg-white px-4 py-2 rounded-xl shadow-sm text-[10px] font-black text-slate-500">â† è¿”å›å¤§æœ¬è¥</button>
                <div id="studyModeIndicator" class="text-[10px] font-black bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full uppercase">æ·±åº¦æ¨¡å¼</div>
            </div>

            <div class="bg-white rounded-[3.5rem] shadow-2xl min-h-[500px] flex flex-col relative border border-slate-100 overflow-hidden">
                <div id="progressBar" class="absolute top-0 left-0 h-2 bg-indigo-500 transition-all duration-500" style="width: 0%"></div>
                
                <div class="p-12 text-center flex-grow flex flex-col justify-center">
                    <p id="counterText" class="text-[10px] font-black text-slate-300 mb-4 tracking-widest">0 / 0</p>
                    <h2 id="questionText" class="text-5xl font-black text-slate-800 mb-12 leading-tight">...</h2>

                    <div class="space-y-6 max-w-xs mx-auto w-full">
                        <input type="text" id="input1" class="w-full border-b-4 border-slate-100 py-3 text-3xl focus:outline-none focus:border-indigo-500 text-center font-bold" placeholder="..." autocomplete="off">
                        <input type="text" id="input2" class="hidden-section w-full border-b-4 border-slate-100 py-3 text-3xl focus:outline-none focus:border-indigo-500 text-center font-bold" placeholder="è¾“å…¥æ±‰å­—" autocomplete="off">
                        <p id="feedback" class="text-[11px] font-black mt-4 h-4"></p>
                    </div>
                </div>

                <div class="p-8 bg-slate-50 flex space-x-4">
                    <button id="btnSubmit" onclick="handleAction()" class="flex-grow bg-indigo-600 text-white font-black py-5 rounded-2xl shadow-lg active:scale-95 transition text-lg">éªŒè¯ (Enter)</button>
                    <button id="btnNext" onclick="loadNextWord()" class="hidden-section flex-grow bg-emerald-500 text-white font-black py-5 rounded-2xl shadow-lg transition text-lg">ä¸‹ä¸€ä¸ª (Enter)</button>
                </div>
            </div>
        </div>

        <div id="finishSection" class="hidden-section w-full max-w-md bg-white p-12 rounded-[3.5rem] shadow-2xl text-center">
            <div class="text-7xl mb-6">ğŸ†</div>
            <h2 class="text-3xl font-black mb-8">ä»Šå¤©çš„ä»»åŠ¡å·²è¾¾æˆ</h2>
            <button onclick="location.reload()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl">è¿”å›é¦–é¡µ</button>
        </div>
    </main>

    <div id="nbModal" class="hidden-section fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-[2.5rem] w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-6 bg-slate-50 border-b flex justify-between items-center">
                <h3 class="font-black text-xl">ğŸ“• Gina çš„ç”Ÿè¯èµ„äº§</h3>
                <button onclick="toggleModal('nbModal')" class="text-2xl font-black">&times;</button>
            </div>
            <div id="nbList" class="p-4 overflow-y-auto flex-grow space-y-2"></div>
            <div class="p-6 border-t bg-slate-50 flex space-x-3">
                <button onclick="startInstant('nb')" class="flex-grow bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg">âš”ï¸ çªå‡»å¤ä¹ ç”Ÿè¯</button>
                <button onclick="exportExcel()" class="bg-white border text-indigo-600 font-black px-6 rounded-2xl">å¯¼å‡ºå¤‡ä»½</button>
            </div>
        </div>
    </div>

    <div id="sbModal" class="hidden-section fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-[2.5rem] w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl overflow-hidden border-4 border-slate-800">
            <div class="p-6 bg-slate-800 text-white flex justify-between items-center">
                <h3 class="font-black text-xl">â˜ ï¸ é¡½å›ºè®°å¿†ç‚¹</h3>
                <button onclick="toggleModal('sbModal')" class="text-2xl font-black">&times;</button>
            </div>
            <div id="sbList" class="p-4 overflow-y-auto flex-grow space-y-2"></div>
            <div class="p-6 bg-slate-100"><button onclick="startInstant('sb')" class="w-full bg-slate-800 text-white font-black py-4 rounded-2xl">âš”ï¸ ç«‹å³æ¸…å‰¿</button></div>
        </div>
    </div>

    <script>
        let studyQueue = [], currentIndex = 0, currentWord = null, studyMode = 'deep';
        
        // æ•°æ®å…¼å®¹ï¼šå°è¯•è¯»å–æ‰€æœ‰å·²çŸ¥çš„ key
        let vocabNotebook = JSON.parse(localStorage.getItem('gina_vocab_notebook')) || 
                            JSON.parse(localStorage.getItem('gina_nb')) || [];
        let stubbornNotebook = JSON.parse(localStorage.getItem('gina_stubborn_notebook')) || 
                               JSON.parse(localStorage.getItem('gina_sb')) || [];

        const tips = ["æ‰§è¡Œç›®æ ‡ï¼Œè€Œä¸æ˜¯ä¸€ç›´åœ¨è®¡åˆ’ç›®æ ‡ã€‚", "å…ˆéš¾åæ˜“ï¼Œè§£å†³é—®é¢˜ã€‚", "å±è”½æƒ…ç»ªçš„è¯¯å¯¼ï¼Œç”¨ç†æ€§çœ‹å¾…ã€‚", "æ‹…å¾—èµ·è´£ä»»äºŒå­—ã€‚", "ä¸è¦è‡ªå‘ã€‚"];

        window.onload = () => {
            const days = Math.ceil((new Date('2026-07-05') - new Date()) / (1000*60*60*24));
            document.getElementById('countdown').innerText = days > 0 ? days : "GO!";
            document.getElementById('motto').innerText = tips[Math.floor(Math.random()*tips.length)];
            document.getElementById('todayTip').innerText = tips[Math.floor(Math.random()*tips.length)];
            updateUI();
            checkResume();
            setMode('deep');
        };

        // --- æ ¸å¿ƒï¼šæ–‡ä»¶å¤„ç† ---
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                const workbook = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                studyQueue = rows.slice(1).map(row => {
                    let w = String(row[0]||"").trim(), r = String(row[1]||"").trim(), m = String(row[2]||"").trim();
                    if(!w) return null;
                    let isK = /[\u4E00-\u9FAF]/.test(w);
                    return { word: w, reading: isK ? r : w, meaning: m || r, isKanji: isK };
                }).filter(i => i);
                if(studyQueue.length) { 
                    studyQueue.sort(() => Math.random() - 0.5);
                    currentIndex = 0; startStudy(); 
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function setMode(m) {
            studyMode = m;
            document.getElementById('modeQuick').className = (m === 'quick' ? 'active-btn' : 'bg-slate-100') + ' flex-1 py-3 rounded-xl font-bold text-sm transition';
            document.getElementById('modeDeep').className = (m === 'deep' ? 'active-btn' : 'bg-slate-100') + ' flex-1 py-3 rounded-xl font-bold text-sm transition';
            document.getElementById('studyModeIndicator').innerText = (m === 'deep' ? 'æ·±åº¦æ¨¡å¼' : 'æé€Ÿæ¨¡å¼');
            if(currentWord) updateInputUI();
        }

        function startStudy() {
            document.getElementById('homeSection').classList.add('hidden-section');
            document.getElementById('studySection').classList.remove('hidden-section');
            loadNextWord();
        }

        function loadNextWord() {
            if (currentIndex >= studyQueue.length) { showFinish(); return; }
            currentWord = studyQueue[currentIndex];
            
            document.getElementById('questionText').innerText = currentWord.meaning;
            document.getElementById('counterText').innerText = `${currentIndex + 1} / ${studyQueue.length}`;
            document.getElementById('progressBar').style.width = `${(currentIndex/studyQueue.length)*100}%`;
            
            updateInputUI();
            document.getElementById('feedback').innerText = '';
            document.getElementById('btnSubmit').classList.remove('hidden-section');
            document.getElementById('btnNext').classList.add('hidden-section');
            setTimeout(() => document.getElementById('input1').focus(), 50);
            
            localStorage.setItem('gina_v61_snap', JSON.stringify({q: studyQueue, i: currentIndex, m: studyMode}));
        }

        function updateInputUI() {
            document.getElementById('input1').value = '';
            document.getElementById('input2').value = '';
            document.getElementById('input1').disabled = false;
            document.getElementById('input2').classList.add('hidden-section');
            document.getElementById('input1').placeholder = (studyMode === 'deep' && currentWord.isKanji) ? "è¾“å…¥è¯»éŸ³ (å‡å)" : "è¾“å…¥æ‹¼å†™";
        }

        function handleAction() {
            const v1 = document.getElementById('input1').value.trim().toLowerCase();
            const v2 = document.getElementById('input2').value.trim().toLowerCase();
            const isStep2 = !document.getElementById('input2').classList.contains('hidden-section');

            if (!isStep2) {
                let target = (studyMode === 'deep' && currentWord.isKanji) ? currentWord.reading : currentWord.word;
                if (v1 === target.toLowerCase()) {
                    if (studyMode === 'deep' && currentWord.isKanji) {
                        document.getElementById('input2').classList.remove('hidden-section');
                        document.getElementById('input1').disabled = true;
                        document.getElementById('input2').focus();
                    } else { win(); }
                } else { fail(target); }
            } else {
                if (v2 === currentWord.word.toLowerCase()) { win(); } else { fail(currentWord.word); }
            }
        }

        function win() {
            document.getElementById('feedback').innerText = "âœ“ æ‰§è¡Œæ­£ç¡®";
            document.getElementById('feedback').className = "text-[11px] font-black mt-4 text-emerald-500";
            document.getElementById('btnSubmit').classList.add('hidden-section');
            document.getElementById('btnNext').classList.remove('hidden-section').focus();
            currentIndex++;
        }

        function fail(t) {
            document.getElementById('feedback').innerText = `âŒ é”™è¯¯ (æç¤º: ${t})`;
            document.getElementById('feedback').className = "text-[11px] font-black mt-4 text-red-500";
            if (!vocabNotebook.find(i => i.word === currentWord.word)) {
                vocabNotebook.unshift(currentWord);
                saveData(); updateUI();
            }
        }

        // --- ç”Ÿè¯/æ•°æ® ---
        function updateUI() {
            document.getElementById('navNb').innerText = vocabNotebook.length;
            document.getElementById('navSb').innerText = stubbornNotebook.length;
            renderList('nbList', vocabNotebook, 'nb');
            renderList('sbList', stubbornNotebook, 'sb');
        }

        function renderList(id, data, type) {
            const box = document.getElementById(id); box.innerHTML = '';
            data.forEach((w, i) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100";
                div.innerHTML = `<div><b class="text-sm">${w.word}</b> <span class="text-[10px] text-slate-400">${w.reading}</span><p class="text-[10px] opacity-60">${w.meaning}</p></div>
                                <button onclick="delWord(${i},'${type}')" class="text-indigo-600 font-bold text-xs">æŒæ¡</button>`;
                box.appendChild(div);
            });
        }

        function delWord(i, t) {
            if(t === 'nb') vocabNotebook.splice(i,1); else stubbornNotebook.splice(i,1);
            saveData(); updateUI();
        }

        function saveData() {
            localStorage.setItem('gina_vocab_notebook', JSON.stringify(vocabNotebook));
            localStorage.setItem('gina_stubborn_notebook', JSON.stringify(stubbornNotebook));
        }

        function startInstant(type) {
            let data = (type === 'nb') ? vocabNotebook : stubbornNotebook;
            if(!data.length) return;
            studyQueue = [...data].sort(() => Math.random() - 0.5);
            currentIndex = 0;
            toggleModal(type + 'Modal');
            startStudy();
        }

        function checkResume() {
            if(localStorage.getItem('gina_v61_snap')) document.getElementById('resumeBox').classList.remove('hidden-section');
        }

        function resumeStudy() {
            const d = JSON.parse(localStorage.getItem('gina_v61_snap'));
            studyQueue = d.q; currentIndex = d.i; studyMode = d.m || 'deep'; setMode(studyMode); startStudy();
        }

        function showFinish() {
            document.getElementById('studySection').classList.add('hidden-section');
            document.getElementById('finishSection').classList.remove('hidden-section');
            localStorage.removeItem('gina_v61_snap');
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden-section'); }
        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(vocabNotebook);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Vocab");
            XLSX.writeFile(wb, `Gina_Words.xlsx`);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (!document.getElementById('btnNext').classList.contains('hidden-section')) loadNextWord();
                else if (!document.getElementById('studySection').classList.contains('hidden-section')) handleAction();
            }
        });
    </script>
</body>
</html>
