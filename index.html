<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G-COMMANDER - JLPT å•è¯è®­ç»ƒ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
    body { 
      font-family: 'Noto Sans SC', sans-serif;
      background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
      min-height: 100vh;
    }
    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .gradient-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
    }
    input:focus { outline: none; }
    .shake { animation: shake 0.5s; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
  </style>
</head>
<body class="p-4">
  <div id="app" class="max-w-4xl mx-auto"></div>

  <script>
    const APP = {
      state: {
        page: 'home',
        words: [],
        current: 0,
        mode: 'deep',
        step: 'reading', // 'reading' | 'kanji' | 'done'
        input: '',
        feedback: '',
        progress: { studied: 0, correct: 0 },
        notebook: [], // ç”Ÿè¯æœ¬
        stubborn: []  // é¡½å›ºæœ¬ (é”™è¯¯3æ¬¡ä»¥ä¸Š)
      },
      
      init() {
        this.loadData();
        this.render();
      },
      
      loadData() {
        const nb = localStorage.getItem('gina_nb');
        const sb = localStorage.getItem('gina_stubborn');
        const prog = localStorage.getItem('gina_progress');
        if (nb) this.state.notebook = JSON.parse(nb);
        if (sb) this.state.stubborn = JSON.parse(sb);
        if (prog) this.state.progress = JSON.parse(prog);
      },
      
      saveData() {
        localStorage.setItem('gina_nb', JSON.stringify(this.state.notebook));
        localStorage.setItem('gina_stubborn', JSON.stringify(this.state.stubborn));
        localStorage.setItem('gina_progress', JSON.stringify(this.state.progress));
      },
      
      render() {
        const el = document.getElementById('app');
        el.innerHTML = this.state.page === 'home' ? this.renderHome() : this.renderTrain();
        this.attachEvents();
      },
      
      renderHome() {
        const targetDate = new Date('2026-07-05');
        const today = new Date();
        const daysLeft = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        const quotes = [
          "å±è”½æƒ…ç»ªè¯¯å¯¼,ç”¨ç†æ€§çœ‹å¾…",
          "æ‹…å¾—èµ·è´£ä»»äºŒå­—",
          "Excellence is not a skill, it's an attitude",
          "å®Œæˆæ¯”å®Œç¾æ›´é‡è¦"
        ];
        const quote = quotes[Math.floor(Math.random() * quotes.length)];
        
        return `
          <div class="space-y-6">
            <div class="gradient-card rounded-3xl p-8 text-white">
              <h1 class="text-4xl font-bold mb-2">G-COMMANDER</h1>
              <p class="text-lg opacity-90 mb-6">JLPT å†²åˆºè®­ç»ƒç³»ç»Ÿ</p>
              <div class="bg-white/20 rounded-2xl p-6 mb-4">
                <div class="text-5xl font-bold mb-2">${daysLeft}</div>
                <div class="text-sm opacity-90">è·ç¦» JLPT è€ƒè¯•è¿˜æœ‰å¤©æ•°</div>
              </div>
              <div class="bg-white/10 rounded-xl p-4 italic">
                "${quote}"
              </div>
            </div>
            
            <div class="glass rounded-2xl p-6 text-white">
              <h2 class="text-xl font-semibold mb-4">ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h2>
              <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="text-center">
                  <div class="text-3xl font-bold text-purple-400">${this.state.progress.studied}</div>
                  <div class="text-sm opacity-70">å·²å­¦ä¹ </div>
                </div>
                <div class="text-center">
                  <div class="text-3xl font-bold text-green-400">${this.state.notebook.length}</div>
                  <div class="text-sm opacity-70">ç”Ÿè¯æœ¬</div>
                </div>
                <div class="text-center">
                  <div class="text-3xl font-bold text-red-400">${this.state.stubborn.length}</div>
                  <div class="text-sm opacity-70">é¡½å›ºæœ¬</div>
                </div>
              </div>
              
              <div class="space-y-3">
                <label class="block bg-white/5 rounded-lg p-4 cursor-pointer hover:bg-white/10 transition">
                  <input type="file" accept=".xlsx,.xls" class="hidden" id="fileInput">
                  <div class="text-center">
                    <div class="text-2xl mb-1">ğŸ“</div>
                    <div class="font-medium">ä¸Šä¼ å•è¯è¡¨ (Excel)</div>
                    <div class="text-xs opacity-60 mt-1">æ ¼å¼: Aåˆ—-å•è¯ | Båˆ—-è¯»éŸ³ | Cåˆ—-å«ä¹‰</div>
                  </div>
                </label>
                
                ${this.state.notebook.length > 0 ? `
                  <button class="w-full bg-orange-500 hover:bg-orange-600 rounded-lg p-4 font-medium transition" onclick="APP.startReview()">
                    ğŸ”¥ çªå‡»å¤ä¹ ç”Ÿè¯æœ¬ (${this.state.notebook.length}è¯)
                  </button>
                ` : ''}
                
                ${this.state.stubborn.length > 0 ? `
                  <button class="w-full bg-red-500 hover:bg-red-600 rounded-lg p-4 font-medium transition" onclick="APP.startStubborn()">
                    ğŸ’€ æ”»å…‹é¡½å›ºæœ¬ (${this.state.stubborn.length}è¯)
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      },
      
      renderTrain() {
        if (this.state.words.length === 0) return '<div class="text-white text-center">åŠ è½½ä¸­...</div>';
        
        const w = this.state.words[this.state.current];
        if (!w) {
          return `
            <div class="glass rounded-2xl p-8 text-white text-center">
              <div class="text-6xl mb-4">ğŸ‰</div>
              <h2 class="text-3xl font-bold mb-4">å®Œæˆæœ¬è½®è®­ç»ƒ!</h2>
              <div class="text-lg mb-6">
                æ­£ç¡®ç‡: ${Math.round(this.state.progress.correct / this.state.progress.studied * 100)}%
              </div>
              <button class="bg-purple-500 hover:bg-purple-600 px-8 py-3 rounded-lg font-medium transition" onclick="APP.goHome()">
                è¿”å›é¦–é¡µ
              </button>
            </div>
          `;
        }
        
        const hasKanji = /[\u4e00-\u9faf]/.test(w.word);
        const progress = Math.round((this.state.current / this.state.words.length) * 100);
        
        return `
          <div class="space-y-6">
            <div class="flex justify-between items-center text-white mb-2">
              <button onclick="APP.goHome()" class="text-sm opacity-70 hover:opacity-100">â† è¿”å›</button>
              <div class="text-sm opacity-70">${this.state.current + 1} / ${this.state.words.length}</div>
            </div>
            
            <div class="bg-white/10 rounded-full h-2 overflow-hidden">
              <div class="bg-purple-500 h-full transition-all duration-300" style="width: ${progress}%"></div>
            </div>
            
            <div class="glass rounded-3xl p-8 text-white">
              <div class="text-center mb-8">
                <div class="text-sm opacity-60 mb-2">å«ä¹‰</div>
                <div class="text-3xl font-bold">${w.meaning}</div>
              </div>
              
              ${this.state.step === 'reading' ? `
                <div class="space-y-4">
                  <div class="text-sm opacity-70">è¯·è¾“å…¥è¯»éŸ³ (å‡å)</div>
                  <input 
                    type="text" 
                    id="inputBox"
                    class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-lg text-white placeholder-white/40"
                    placeholder="ã²ã‚‰ãŒãª"
                    value="${this.state.input}"
                  >
                  ${this.state.feedback ? `
                    <div class="text-center ${this.state.feedback === 'correct' ? 'text-green-400' : 'text-red-400'}">
                      ${this.state.feedback === 'correct' ? 'âœ“ æ­£ç¡®!' : `âœ— æ­£ç¡®ç­”æ¡ˆ: ${w.reading}`}
                    </div>
                  ` : ''}
                </div>
              ` : this.state.step === 'kanji' ? `
                <div class="space-y-4">
                  <div class="text-center mb-4">
                    <div class="text-sm opacity-60">è¯»éŸ³</div>
                    <div class="text-2xl text-green-400">${w.reading}</div>
                  </div>
                  <div class="text-sm opacity-70">è¯·è¾“å…¥å•è¯ (æ±‰å­—/å‡å)</div>
                  <input 
                    type="text" 
                    id="inputBox"
                    class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-lg text-white placeholder-white/40"
                    placeholder="æ¼¢å­—"
                    value="${this.state.input}"
                  >
                  ${this.state.feedback ? `
                    <div class="text-center ${this.state.feedback === 'correct' ? 'text-green-400' : 'text-red-400'}">
                      ${this.state.feedback === 'correct' ? 'âœ“ æ­£ç¡®!' : `âœ— æ­£ç¡®ç­”æ¡ˆ: ${w.word}`}
                    </div>
                  ` : ''}
                </div>
              ` : `
                <div class="text-center space-y-4">
                  <div class="text-2xl text-green-400">${w.word}</div>
                  <div class="text-xl opacity-80">${w.reading}</div>
                  <button 
                    id="nextBtn"
                    class="w-full bg-green-500 hover:bg-green-600 rounded-lg py-3 font-medium transition"
                  >
                    ä¸‹ä¸€ä¸ª (æŒ‰ Enter)
                  </button>
                </div>
              `}
            </div>
          </div>
        `;
      },
      
      attachEvents() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
          fileInput.onchange = (e) => this.handleFile(e);
        }
        
        const inputBox = document.getElementById('inputBox');
        if (inputBox) {
          inputBox.focus();
          inputBox.oninput = (e) => {
            this.state.input = e.target.value;
          };
          inputBox.onkeydown = (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              this.handleSubmit();
            }
          };
        }
        
        const nextBtn = document.getElementById('nextBtn');
        if (nextBtn) {
          nextBtn.onclick = () => this.nextWord();
          nextBtn.focus();
          document.onkeydown = (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              this.nextWord();
            }
          };
        }
      },
      
      handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (evt) => {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          
          this.state.words = json
            .filter(row => row[0] && row[1] && row[2])
            .map(row => ({
              word: String(row[0]).trim(),
              reading: String(row[1]).trim(),
              meaning: String(row[2]).trim(),
              errors: 0
            }));
          
          if (this.state.words.length > 0) {
            this.state.page = 'train';
            this.state.current = 0;
            this.render();
          }
        };
        reader.readAsArrayBuffer(file);
      },
      
      handleSubmit() {
        const w = this.state.words[this.state.current];
        const input = this.state.input.trim();
        
        if (this.state.step === 'reading') {
          if (input === w.reading) {
            this.state.feedback = 'correct';
            setTimeout(() => {
              this.state.feedback = '';
              const hasKanji = /[\u4e00-\u9faf]/.test(w.word);
              if (hasKanji) {
                this.state.step = 'kanji';
                this.state.input = '';
              } else {
                this.state.step = 'done';
              }
              this.state.progress.studied++;
              this.state.progress.correct++;
              this.render();
            }, 500);
          } else {
            this.state.feedback = 'wrong';
            w.errors = (w.errors || 0) + 1;
            this.addToNotebook(w);
            setTimeout(() => {
              this.state.feedback = '';
              this.state.step = 'done';
              this.state.input = '';
              this.state.progress.studied++;
              this.render();
            }, 1500);
          }
        } else if (this.state.step === 'kanji') {
          if (input === w.word) {
            this.state.feedback = 'correct';
            this.state.progress.correct++;
            setTimeout(() => {
              this.state.feedback = '';
              this.state.step = 'done';
              this.state.input = '';
              this.render();
            }, 500);
          } else {
            this.state.feedback = 'wrong';
            w.errors = (w.errors || 0) + 1;
            this.addToNotebook(w);
            setTimeout(() => {
              this.state.feedback = '';
              this.state.step = 'done';
              this.state.input = '';
              this.render();
            }, 1500);
          }
        }
        
        this.render();
      },
      
      nextWord() {
        this.state.current++;
        this.state.step = 'reading';
        this.state.input = '';
        this.state.feedback = '';
        this.saveData();
        this.render();
      },
      
      addToNotebook(word) {
        const existing = this.state.notebook.find(w => w.word === word.word);
        if (!existing) {
          this.state.notebook.push({ ...word });
        } else {
          existing.errors = (existing.errors || 0) + 1;
        }
        
        if (word.errors >= 3 && !this.state.stubborn.find(w => w.word === word.word)) {
          this.state.stubborn.push({ ...word });
        }
        
        this.saveData();
      },
      
      startReview() {
        this.state.words = this.shuffle([...this.state.notebook]);
        this.state.current = 0;
        this.state.step = 'reading';
        this.state.page = 'train';
        this.render();
      },
      
      startStubborn() {
        this.state.words = this.shuffle([...this.state.stubborn]);
        this.state.current = 0;
        this.state.step = 'reading';
        this.state.page = 'train';
        this.render();
      },
      
      shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      },
      
      goHome() {
        this.state.page = 'home';
        this.state.words = [];
        this.state.current = 0;
        document.onkeydown = null;
        this.render();
      }
    };
    
    APP.init();
  </script>
</body>
</html>
