<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­æ·±åº¦è®°å¿†è®­ç»ƒ V5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-section { display: none; }
        .correct-flash { animation: flashGreen 0.5s; }
        @keyframes flashGreen { 0% { background: white; } 50% { background: #dcfce7; } 100% { background: white; } }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col">

    <nav class="bg-indigo-600 text-white p-4 shadow-md flex justify-between items-center shrink-0">
        <h1 class="font-bold text-lg tracking-wide">ğŸ‡¯ğŸ‡µ æ·±åº¦è®°å¿† V5.0</h1>
        <div class="flex items-center space-x-2 text-sm">
            <select id="modeSelector" onchange="changeMode()" class="bg-indigo-700 text-white px-2 py-1 rounded-lg border-none focus:ring-0 cursor-pointer">
                <option value="deep">æ·±åº¦æ¨¡å¼ (ä¸­â†’æ—¥)</option>
                <option value="recall">å›æƒ³æ¨¡å¼ (æ—¥â†’ä¸­)</option>
            </select>
            <button onclick="toggleModal('stubbornModal')" class="bg-slate-800 px-3 py-1 rounded-full font-bold">â˜ ï¸ <span id="stubbornCountNav">0</span></button>
            <button onclick="toggleModal('notebookModal')" class="bg-white text-indigo-600 px-3 py-1 rounded-full font-bold">ğŸ“• <span id="notebookCountNav">0</span></button>
        </div>
    </nav>

    <main class="flex-grow flex flex-col items-center justify-center p-4 overflow-y-auto">
        
        <div id="uploadSection" class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl text-center fade-in">
            <div class="mb-6">
                <div class="mx-auto h-16 w-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mb-4 text-2xl">ğŸ“‚</div>
                <h2 class="text-2xl font-bold text-slate-700">å¼€å§‹è®­ç»ƒ</h2>
                <p class="text-slate-500 mt-2 text-sm">çº é”™è¡¥ä¸å·²å¯ç”¨ï¼šè‡ªåŠ¨è®°ä½ä½ çš„æ‰‹åŠ¨ä¿®æ”¹</p>
            </div>
            
            <div id="resumeBox" class="hidden-section mb-6 p-4 bg-amber-50 border border-amber-200 rounded-xl text-left">
                <p id="resumeInfo" class="text-xs text-amber-600 mb-3"></p>
                <div class="flex space-x-2">
                    <button onclick="resumeStudy()" class="flex-1 bg-amber-500 text-white text-xs py-2 rounded-lg font-bold shadow">ç»§ç»­ä¸Šæ¬¡</button>
                    <button onclick="clearSavedProgress()" class="flex-1 bg-slate-200 text-slate-600 text-xs py-2 rounded-lg font-bold">é‡æ–°å¼€å§‹</button>
                </div>
            </div>

            <label class="block w-full cursor-pointer bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl transition shadow-lg transform active:scale-95">
                é€‰æ‹© Excel æ–‡ä»¶
                <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls" multiple />
            </label>
        </div>

        <div id="studySection" class="hidden-section w-full max-w-md">
            <div class="mb-4 flex justify-between text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">
                <span>POS: <span id="remainCount">0</span>/<span id="totalCount">0</span></span>
                <span id="percentText">0%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-1.5 mb-6">
                <div id="progressBar" class="bg-indigo-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>

            <div id="cardMain" class="bg-white rounded-3xl shadow-2xl overflow-hidden min-h-[420px] flex flex-col relative fade-in">
                <button onclick="openEditModal()" class="absolute top-4 right-4 text-slate-300 hover:text-indigo-500 p-2 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </button>

                <div class="bg-slate-50 p-8 text-center border-b border-slate-100">
                    <span id="modeLabel" class="inline-block px-3 py-1 bg-indigo-100 text-indigo-600 rounded-full text-[10px] font-bold tracking-widest mb-3 uppercase">MEANING</span>
                    <h3 id="questionText" class="text-3xl font-bold text-slate-800 leading-tight">...</h3>
                </div>

                <div class="p-8 flex-grow flex flex-col justify-center space-y-5">
                    <div id="deepInputs" class="space-y-4">
                        <div id="step1" class="transition-all">
                            <input type="text" id="inputKana" class="w-full border-b-2 border-slate-200 p-2 text-xl focus:outline-none focus:border-indigo-500 text-center placeholder-slate-300" placeholder="è¾“å…¥å‡å..." autocomplete="off">
                        </div>
                        <div id="step2" class="hidden-section transition-all">
                            <input type="text" id="inputKanji" class="w-full border-b-2 border-slate-200 p-2 text-xl focus:outline-none focus:border-indigo-500 text-center placeholder-slate-300" placeholder="è¾“å…¥å†™æ³•..." autocomplete="off">
                        </div>
                    </div>
                    
                    <div id="recallInputs" class="hidden-section space-y-4">
                        <input type="text" id="inputMeaning" class="w-full border-b-2 border-slate-200 p-2 text-xl focus:outline-none focus:border-indigo-500 text-center placeholder-slate-300" placeholder="è¾“å…¥ä¸­æ–‡æ„æ€..." autocomplete="off">
                        <p class="text-[10px] text-center text-slate-400">åŒ¹é…å…³é”®è¯æˆ–æŒ‰ Enter æ­æ™“</p>
                    </div>

                    <div id="feedback" class="text-center text-sm font-bold min-h-[20px] transition-colors"></div>
                </div>

                <div class="p-6 bg-slate-50 flex space-x-3">
                    <button id="btnSubmit" onclick="checkAnswer()" class="flex-grow bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl shadow-lg transition transform active:scale-95">æäº¤ (Enter)</button>
                    <button id="btnNext" onclick="loadNextWord()" class="hidden-section flex-grow bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-2xl shadow-lg transition">ä¸‹ä¸€ä¸ª (Enter)</button>
                </div>
            </div>
        </div>

        <div id="finishSection" class="hidden-section w-full max-w-md bg-white p-10 rounded-3xl shadow-2xl text-center fade-in">
            <div class="text-7xl mb-6">ğŸ†</div>
            <h2 class="text-3xl font-black text-slate-800 mb-2">æ‰§è¡Œå®Œæ¯•</h2>
            <p class="text-slate-500 mb-8">æœ¬æ¬¡é”™é¢˜: <span id="sessionMistakeCount" class="text-red-500 font-bold">0</span></p>
            <div class="space-y-3">
                <button id="btnReviewMistakes" onclick="startReviewMistakes()" class="w-full bg-amber-500 text-white font-bold py-4 rounded-2xl shadow-md transition hover:bg-amber-600">âš”ï¸ ç«‹å³å¤ä¹ é”™é¢˜</button>
                <button onclick="restartCurrentSet()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-md transition hover:bg-indigo-700">ğŸ”„ åŸæ ·å†æ¥ä¸€é</button>
                <button onclick="location.reload()" class="w-full bg-slate-100 text-slate-600 font-bold py-4 rounded-2xl transition hover:bg-slate-200">ğŸ“‚ ç»“æŸå¹¶è¿”å›</button>
            </div>
        </div>
    </main>

    <div id="editModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-8 shadow-2xl">
            <h3 class="font-bold text-xl mb-6 text-slate-800 flex items-center">âœï¸ çº æ­£è¯æ¡</h3>
            <div class="space-y-4">
                <div><label class="text-[10px] font-bold text-slate-400 uppercase">å†™æ³•</label><input id="editKanji" class="w-full border-2 border-slate-100 rounded-xl p-3 mt-1"></div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase">å‡å</label><input id="editKana" class="w-full border-2 border-slate-100 rounded-xl p-3 mt-1"></div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase">ä¸­æ–‡</label><input id="editMeaning" class="w-full border-2 border-slate-100 rounded-xl p-3 mt-1"></div>
            </div>
            <div class="flex space-x-3 mt-8">
                <button onclick="saveEdit()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-indigo-200 shadow-lg">ä¿å­˜ä¿®æ”¹</button>
                <button onclick="toggleModal('editModal')" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="notebookModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl">
            <div class="p-6 border-b flex justify-between items-center bg-indigo-50 rounded-t-3xl"><h3 class="font-bold text-lg">ğŸ“• ç”Ÿè¯æœ¬</h3><button onclick="toggleModal('notebookModal')" class="text-slate-400 text-2xl">&times;</button></div>
            <div class="p-4 overflow-y-auto flex-grow"><table class="w-full text-left"><tbody id="notebookList" class="text-sm"></tbody></table></div>
            <div class="p-4 border-t bg-slate-50 flex justify-between"><button onclick="exportExcel(vocabNotebook, 'ç”Ÿè¯æœ¬')" class="text-indigo-600 font-bold">ğŸ“¥ å¯¼å‡ºExcel</button><button onclick="toggleModal('notebookModal')" class="bg-slate-200 px-4 py-2 rounded-lg font-bold">å…³é—­</button></div>
        </div>
    </div>

    <div id="stubbornModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl border-4 border-slate-800">
            <div class="p-6 border-b bg-slate-800 text-white rounded-t-2xl flex justify-between"><h3>â˜ ï¸ é¡½å›ºåˆ†å­</h3><button onclick="toggleModal('stubbornModal')">&times;</button></div>
            <div class="p-4 overflow-y-auto flex-grow"><table class="w-full text-left"><tbody id="stubbornList" class="text-sm"></tbody></table></div>
            <div class="p-4 border-t bg-slate-50 flex justify-between"><button onclick="exportExcel(stubbornNotebook, 'é¡½å›ºæœ¬')" class="text-slate-800 font-bold">ğŸ“¥ å¯¼å‡ºExcel</button><button onclick="toggleModal('stubbornModal')" class="bg-slate-200 px-4 py-2 rounded-lg font-bold">å…³é—­</button></div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒå˜é‡ ---
        let studyQueue = [];
        let originalQueue = [];
        let currentSessionMistakes = [];
        let currentWord = null;
        let totalWords = 0;
        let currentIndex = 0;
        let wrongAttempts = 0;
        let isReviewMode = false;
        let currentMode = 'deep'; // 'deep' or 'recall'

        // --- çº é”™è¡¥ä¸åº“ ---
        let wordPatches = JSON.parse(localStorage.getItem('gina_word_patches')) || {};

        // --- æŒä¹…åŒ–æ•°æ® ---
        let vocabNotebook = JSON.parse(localStorage.getItem('gina_vocab_notebook')) || [];
        let stubbornNotebook = JSON.parse(localStorage.getItem('gina_stubborn_notebook')) || [];
        let uploadHistory = JSON.parse(localStorage.getItem('gina_upload_history')) || [];

        updateNotebookUI(); updateStubbornUI(); checkSavedProgress();

        // --- é€»è¾‘å‡½æ•° ---
        function normalize(str) {
            if (!str) return "";
            return str.toString().trim().replace(/[ãƒ¼ï¼â€”â€“-]/g, '-').replace(/\s+/g, '').toLowerCase();
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }

        function changeMode() {
            currentMode = document.getElementById('modeSelector').value;
            if (studyQueue.length > 0) loadNextWord();
        }

        // --- çº é”™é€»è¾‘ ---
        function openEditModal() {
            if (!currentWord) return;
            document.getElementById('editKanji').value = currentWord.kanji;
            document.getElementById('editKana').value = currentWord.kana;
            document.getElementById('editMeaning').value = currentWord.meaning;
            toggleModal('editModal');
        }

        function saveEdit() {
            const newKanji = document.getElementById('editKanji').value.trim();
            const newKana = document.getElementById('editKana').value.trim();
            const newMeaning = document.getElementById('editMeaning').value.trim();
            
            // å­˜å…¥è¡¥ä¸åº“ (ä»¥åŸå§‹å†™æ³•ä¸º key)
            const patchKey = currentWord.originalKanji || currentWord.kanji;
            wordPatches[patchKey] = { kanji: newKanji, kana: newKana, meaning: newMeaning };
            localStorage.setItem('gina_word_patches', JSON.stringify(wordPatches));

            // æ›´æ–°å½“å‰é˜Ÿåˆ—
            currentWord.kanji = newKanji;
            currentWord.kana = newKana;
            currentWord.meaning = newMeaning;
            
            toggleModal('editModal');
            loadNextWord(); // é‡æ–°åˆ·æ–°æ˜¾ç¤º
        }

        // --- æ–‡ä»¶å¤„ç† ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = e.target.files; if (!files.length) return;
            let allData = [];
            for (let file of files) {
                const data = await parseExcel(file);
                allData = allData.concat(data);
            }
            if (!allData.length) return;
            
            // åº”ç”¨çº é”™è¡¥ä¸
            allData = allData.map(w => {
                const patch = wordPatches[w.kanji];
                if (patch) {
                    return { ...w, ...patch, originalKanji: w.kanji };
                }
                return w;
            });

            originalQueue = [...allData];
            studyQueue = shuffle(allData);
            totalWords = studyQueue.length;
            currentIndex = 0;
            isReviewMode = false;
            startStudy();
        });

        function parseExcel(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    let list = [];
                    workbook.SheetNames.forEach(n => {
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[n], { header: 1 });
                        for (let i = 1; i < json.length; i++) {
                            if (json[i][0] && json[i][1]) list.push({ kanji: String(json[i][0]).trim(), kana: String(json[i][1]).trim(), meaning: String(json[i][2] || "").trim() });
                        }
                    });
                    resolve(list);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function startStudy() {
            document.getElementById('uploadSection').classList.add('hidden-section');
            document.getElementById('finishSection').classList.add('hidden-section');
            document.getElementById('studySection').classList.remove('hidden-section');
            document.getElementById('totalCount').innerText = totalWords;
            loadNextWord();
        }

        function loadNextWord() {
            if (currentIndex >= studyQueue.length) { showFinishScreen(); return; }
            currentWord = studyQueue[currentIndex];
            wrongAttempts = 0;
            saveSnapshot();

            // UI åˆå§‹åŒ–
            document.getElementById('remainCount').innerText = currentIndex + 1;
            const progress = (currentIndex / totalWords) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('percentText').innerText = `${Math.round(progress)}%`;
            document.getElementById('feedback').innerText = '';
            document.getElementById('btnSubmit').classList.remove('hidden-section');
            document.getElementById('btnNext').classList.add('hidden-section');

            const deepInputs = document.getElementById('deepInputs');
            const recallInputs = document.getElementById('recallInputs');
            const modeLabel = document.getElementById('modeLabel');

            if (currentMode === 'deep') {
                modeLabel.innerText = "MEANING";
                document.getElementById('questionText').innerText = currentWord.meaning;
                deepInputs.classList.remove('hidden-section');
                recallInputs.classList.add('hidden-section');
                document.getElementById('inputKana').value = '';
                document.getElementById('inputKanji').value = '';
                document.getElementById('inputKana').disabled = false;
                document.getElementById('step2').classList.add('hidden-section');
                document.getElementById('step1').classList.remove('opacity-50');
                setTimeout(() => document.getElementById('inputKana').focus(), 50);
            } else {
                modeLabel.innerText = "WORD";
                document.getElementById('questionText').innerText = `${currentWord.kanji}\n(${currentWord.kana})`;
                deepInputs.classList.add('hidden-section');
                recallInputs.classList.remove('hidden-section');
                document.getElementById('inputMeaning').value = '';
                setTimeout(() => document.getElementById('inputMeaning').focus(), 50);
            }
        }

        function checkAnswer() {
            const feedbackEl = document.getElementById('feedback');
            
            if (currentMode === 'deep') {
                const step2Visible = !document.getElementById('step2').classList.contains('hidden-section');
                if (!step2Visible) {
                    if (normalize(document.getElementById('inputKana').value) === normalize(currentWord.kana)) {
                        document.getElementById('inputKana').disabled = true;
                        document.getElementById('step1').classList.add('opacity-50');
                        document.getElementById('step2').classList.remove('hidden-section');
                        document.getElementById('inputKanji').disabled = false;
                        document.getElementById('inputKanji').focus();
                        feedbackEl.innerText = "âœ“ è¯»éŸ³æ­£ç¡®";
                        feedbackEl.className = "text-center text-sm font-bold text-indigo-600";
                    } else { handleWrong("è¯»éŸ³ä¸åŒ¹é…"); }
                } else {
                    if (normalize(document.getElementById('inputKanji').value) === normalize(currentWord.kanji)) {
                        passWord();
                    } else { handleWrong("å†™æ³•ä¸åŒ¹é…"); }
                }
            } else {
                // å›æƒ³æ¨¡å¼ï¼šæ¨¡ç³ŠåŒ¹é…å…³é”®è¯
                const input = document.getElementById('inputMeaning').value.trim();
                if (input && (currentWord.meaning.includes(input) || input.includes(currentWord.meaning))) {
                    passWord();
                } else {
                    // å¦‚æœæ²¡åŒ¹é…åˆ°ï¼Œå±•ç¤ºç­”æ¡ˆè®©ç”¨æˆ·è‡ªæˆ‘åˆ¤æ–­ï¼ˆæŒ‰ Enter ä¸¤æ¬¡å³å¯è·³è¿‡ï¼‰
                    if (wrongAttempts === 0) {
                        feedbackEl.innerText = `æç¤º: ${currentWord.meaning}`;
                        feedbackEl.className = "text-center text-sm font-bold text-amber-500";
                        wrongAttempts++;
                    } else {
                        passWord(); // ç¬¬äºŒæ¬¡ç›´æ¥é€šè¿‡ï¼Œè®¤ä¸ºç”¨æˆ·å·²ç¡®è®¤
                    }
                }
            }
        }

        function passWord() {
            document.getElementById('cardMain').classList.add('correct-flash');
            setTimeout(() => document.getElementById('cardMain').classList.remove('correct-flash'), 500);
            document.getElementById('feedback').innerText = "ğŸ‰ æ­£ç¡®";
            document.getElementById('feedback').className = "text-center text-sm font-bold text-green-600";
            currentIndex++;
            saveSnapshot();
            document.getElementById('btnSubmit').classList.add('hidden-section');
            document.getElementById('btnNext').classList.remove('hidden-section').focus();
        }

        function handleWrong(m) {
            wrongAttempts++;
            const f = document.getElementById('feedback');
            f.innerText = `âŒ ${m} (${wrongAttempts >= 3 ? currentWord.kana + ' / ' + currentWord.kanji : 'å†è¯•ä¸€æ¬¡'})`;
            f.className = "text-center text-sm font-bold text-red-500 animate-pulse";
            if (wrongAttempts === 3) {
                if (!currentSessionMistakes.some(w => w.kanji === currentWord.kanji)) currentSessionMistakes.push(currentWord);
                if (isReviewMode) {
                    if (!stubbornNotebook.some(i => i.kanji === currentWord.kanji)) {
                        stubbornNotebook.unshift(currentWord);
                        localStorage.setItem('gina_stubborn_notebook', JSON.stringify(stubbornNotebook));
                        updateStubbornUI();
                    }
                } else {
                    if (!vocabNotebook.some(i => i.kanji === currentWord.kanji)) {
                        vocabNotebook.unshift(currentWord);
                        localStorage.setItem('gina_vocab_notebook', JSON.stringify(vocabNotebook));
                        updateNotebookUI();
                    }
                }
            }
        }

        // --- å…¶ä»–æ”¯æŒå‡½æ•° (å­˜æ¡£/æ˜¾ç¤º/å¯¼å‡ºç­‰) ---
        function showFinishScreen() {
            document.getElementById('studySection').classList.add('hidden-section');
            document.getElementById('finishSection').classList.remove('hidden-section');
            document.getElementById('sessionMistakeCount').innerText = currentSessionMistakes.length;
            if (!isReviewMode) clearSavedProgress();
        }

        function restartCurrentSet() {
            studyQueue = shuffle([...originalQueue]);
            currentIndex = 0; totalWords = studyQueue.length;
            currentSessionMistakes = []; isReviewMode = false;
            startStudy();
        }

        function startReviewMistakes() {
            if (!currentSessionMistakes.length) return;
            studyQueue = shuffle([...currentSessionMistakes]);
            currentIndex = 0; totalWords = studyQueue.length;
            isReviewMode = true; startStudy();
        }

        function updateNotebookUI() { renderList('notebookList', vocabNotebook, 'notebookCountNav', 'normal'); }
        function updateStubbornUI() { renderList('stubbornList', stubbornNotebook, 'stubbornCountNav', 'stubborn'); }
        function renderList(id, data, navId, type) {
            document.getElementById(navId).innerText = data.length;
            const el = document.getElementById(id); el.innerHTML = '';
            data.forEach((w, i) => {
                const r = document.createElement('tr'); r.className = "border-b text-xs";
                r.innerHTML = `<td class="py-3 font-bold">${w.kanji}</td><td class="px-2">${w.kana}</td><td>${w.meaning}</td><td class="text-right"><button onclick="removeNB(${i}, '${type}')" class="text-indigo-600 font-bold">æŒæ¡</button></td>`;
                el.appendChild(r);
            });
        }
        function removeNB(i, t) {
            if (t === 'normal') { vocabNotebook.splice(i, 1); localStorage.setItem('gina_vocab_notebook', JSON.stringify(vocabNotebook)); updateNotebookUI(); }
            else { stubbornNotebook.splice(i, 1); localStorage.setItem('gina_stubborn_notebook', JSON.stringify(stubbornNotebook)); updateStubbornUI(); }
        }
        function exportExcel(data, name) {
            const ws = XLSX.utils.aoa_to_sheet(data.map(w => [w.kanji, w.kana, w.meaning]));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Words");
            XLSX.writeFile(wb, `${name}.xlsx`);
        }
        function saveSnapshot() { if (!isReviewMode && studyQueue.length) localStorage.setItem('gina_study_snapshot', JSON.stringify({ queue: studyQueue, index: currentIndex })); }
        function checkSavedProgress() {
            const s = localStorage.getItem('gina_study_snapshot');
            if (s) {
                const data = JSON.parse(s);
                document.getElementById('resumeBox').classList.remove('hidden-section');
                document.getElementById('resumeInfo').innerText = `å‘ç°æœªå®Œè¿›åº¦: ${data.index}/${data.queue.length}`;
            }
        }
        function resumeStudy() { const s = JSON.parse(localStorage.getItem('gina_study_snapshot')); studyQueue = s.queue; currentIndex = s.index; totalWords = studyQueue.length; startStudy(); }
        function clearSavedProgress() { localStorage.removeItem('gina_study_snapshot'); document.getElementById('resumeBox').classList.add('hidden-section'); }
        function shuffle(a) { let r = [...a]; for (let i = r.length - 1; i > 0; i--) { let j = Math.floor(Math.random() * (i + 1)); [r[i], r[j]] = [r[j], r[i]]; } return r; }
        function updateHistoryUI() {} // ç®€åŒ–ç‰ˆæš‚ä¸æ›´æ–°å†å²åˆ—è¡¨

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (!document.getElementById('studySection').classList.contains('hidden-section')) {
                    const btnSubmit = document.getElementById('btnSubmit');
                    if (!btnSubmit.classList.contains('hidden-section')) { checkAnswer(); e.preventDefault(); }
                    else { loadNextWord(); e.preventDefault(); }
                }
            }
            if (e.key === 'Escape') toggleModal('editModal');
        });
    </script>
</body>
</html>
