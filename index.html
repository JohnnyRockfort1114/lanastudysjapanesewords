<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­æ·±åº¦è®°å¿†è®­ç»ƒ V4.0 (é—­ç¯è¿›åŒ–ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-section { display: none; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col">

    <nav class="bg-indigo-600 text-white p-4 shadow-md flex justify-between items-center shrink-0">
        <h1 class="font-bold text-lg tracking-wide">ğŸ‡¯ğŸ‡µ æ·±åº¦è®°å¿† V4.0</h1>
        <div class="space-x-2 text-sm flex">
            <button onclick="toggleModal('historyModal')" class="hover:text-indigo-200 transition px-2">ğŸ“œ å†å²</button>
            <button onclick="toggleModal('stubbornModal')" class="bg-slate-800 text-white px-3 py-1 rounded-full font-bold hover:bg-slate-700 transition shadow border border-slate-600">â˜ ï¸ é¡½å›º (<span id="stubbornCountNav">0</span>)</button>
            <button onclick="toggleModal('notebookModal')" class="bg-white text-indigo-600 px-3 py-1 rounded-full font-bold hover:bg-indigo-50 transition shadow">ğŸ“• ç”Ÿè¯ (<span id="notebookCountNav">0</span>)</button>
        </div>
    </nav>

    <main class="flex-grow flex flex-col items-center justify-center p-4 overflow-y-auto">
        
        <div id="uploadSection" class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl text-center fade-in">
            <div class="mb-6">
                <div class="mx-auto h-16 w-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mb-4 text-2xl">ğŸ“‚</div>
                <h2 class="text-2xl font-bold text-slate-700">å¼€å§‹è®­ç»ƒ</h2>
                <p class="text-slate-500 mt-2 text-sm">æ”¯æŒå¯¼å‡ºç”Ÿè¯ -> é‡æ–°ä¸Šä¼ å¤ä¹ </p>
            </div>
            
            <div id="resumeBox" class="hidden-section mb-6 p-4 bg-amber-50 border border-amber-200 rounded-xl text-left">
                <p class="text-xs font-bold text-amber-700 mb-2">ä¸Šæ¬¡æœªå®Œæˆï¼š</p>
                <p id="resumeInfo" class="text-xs text-amber-600 mb-3"></p>
                <div class="flex space-x-2">
                    <button onclick="resumeStudy()" class="flex-1 bg-amber-500 text-white text-xs py-2 rounded-lg font-bold">ç»§ç»­</button>
                    <button onclick="clearSavedProgress()" class="flex-1 bg-slate-200 text-slate-600 text-xs py-2 rounded-lg font-bold">æ”¾å¼ƒ</button>
                </div>
            </div>

            <label class="block w-full cursor-pointer bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition shadow-lg transform active:scale-95">
                é€‰æ‹©æ–‡ä»¶
                <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls" multiple />
            </label>
        </div>

        <div id="studySection" class="hidden-section w-full max-w-md">
            <div class="mb-4 flex justify-between text-xs font-bold text-slate-500 px-1">
                <span>ä½ç½®: <span id="remainCount">0</span> / <span id="totalCount">0</span></span>
                <span><span id="percentText">0%</span></span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2 mb-6">
                <div id="progressBar" class="bg-indigo-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl overflow-hidden min-h-[400px] flex flex-col relative fade-in">
                <div id="modeBanner" class="hidden-section bg-amber-100 text-amber-800 text-xs font-bold text-center py-1">
                    âš”ï¸ é”™é¢˜å¤ä¹ æ¨¡å¼ï¼šå†é”™å°†è¿›å…¥é¡½å›ºç”Ÿè¯æœ¬
                </div>

                <div class="bg-slate-50 p-6 text-center border-b border-slate-100">
                    <span class="inline-block px-3 py-1 bg-indigo-100 text-indigo-600 rounded-full text-xs font-bold tracking-wider mb-2">ä¸­æ–‡å«ä¹‰</span>
                    <h3 id="questionText" class="text-3xl font-bold text-slate-800 min-h-[48px] flex items-center justify-center">...</h3>
                </div>

                <div class="p-6 flex-grow flex flex-col justify-center space-y-4">
                    <div id="step1" class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase">Step 1: è¯»éŸ³</label>
                        <input type="text" id="inputKana" class="w-full border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-indigo-500 transition text-center" autocomplete="off">
                    </div>
                    <div id="step2" class="hidden-section space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase">Step 2: å†™æ³•</label>
                        <input type="text" id="inputKanji" class="w-full border-2 border-slate-200 rounded-xl p-3 text-lg focus:outline-none focus:border-indigo-500 transition text-center" autocomplete="off">
                    </div>
                    <div id="feedback" class="text-center text-sm font-bold min-h-[24px]"></div>
                </div>

                <div class="p-4 bg-slate-50 border-t border-slate-100 flex space-x-2">
                    <button id="btnSubmit" onclick="checkAnswer()" class="flex-grow bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-md transition transform active:scale-95">æäº¤ (Enter)</button>
                    <button id="btnNext" onclick="loadNextWord()" class="hidden-section flex-grow bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-md transition transform active:scale-95">ä¸‹ä¸€ä¸ª (Enter)</button>
                </div>
            </div>
        </div>

        <div id="finishSection" class="hidden-section w-full max-w-md bg-white p-8 rounded-2xl shadow-xl text-center fade-in">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">æœ¬è½®ä»»åŠ¡å®Œæˆï¼</h2>
            <p class="text-slate-500 mb-6 text-sm">é”™é¢˜å·²è‡ªåŠ¨æ”¶å½•ã€‚æ¥ä¸‹æ¥æ€ä¹ˆåšï¼Ÿ</p>
            
            <div class="space-y-3">
                <button id="btnReviewMistakes" onclick="startReviewMistakes()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-xl shadow-md transition">
                    âš”ï¸ ç«‹å³å¤ä¹ æœ¬æ¬¡é”™é¢˜ (<span id="sessionMistakeCount">0</span>)
                </button>
                <button onclick="restartCurrentSet()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-md transition">
                    ğŸ”„ æœ¬ç»„å•è¯å†åˆ·ä¸€é
                </button>
                <button onclick="location.reload()" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 rounded-xl shadow-md transition">
                    ğŸ“‚ ä¸Šä¼ æ–°çš„æ–‡ä»¶
                </button>
            </div>
        </div>
    </main>

    <div id="notebookModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center bg-indigo-50 rounded-t-2xl"><h3 class="font-bold text-lg text-indigo-900">ğŸ“• ç”Ÿè¯æœ¬ (é”™è¯¯æ”¶å½•)</h3><button onclick="toggleModal('notebookModal')" class="text-slate-400 text-2xl">&times;</button></div>
            <div class="p-4 overflow-y-auto flex-grow"><table class="w-full text-left"><tbody id="notebookList" class="text-sm"></tbody></table><div id="emptyNotebookMsg" class="text-center text-slate-400 py-10 hidden">æš‚æ— ç”Ÿè¯ã€‚</div></div>
            <div class="p-4 border-t bg-slate-50 flex justify-between">
                <button onclick="exportExcel(vocabNotebook, 'æˆ‘çš„ç”Ÿè¯æœ¬')" class="text-indigo-600 font-bold text-sm hover:underline">ğŸ“¥ å¯¼å‡ºExcel</button>
                <div>
                    <button onclick="clearNotebook('normal')" class="text-red-500 text-xs mr-4 hover:underline">æ¸…ç©º</button>
                    <button onclick="toggleModal('notebookModal')" class="bg-slate-200 px-4 py-2 rounded-lg text-sm font-bold">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <div id="stubbornModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl border-2 border-slate-700">
            <div class="p-4 border-b flex justify-between items-center bg-slate-800 text-white rounded-t-xl"><h3 class="font-bold text-lg">â˜ ï¸ é¡½å›ºç”Ÿè¯ (é‡ç‚¹æ‰“å‡»)</h3><button onclick="toggleModal('stubbornModal')" class="text-slate-400 text-2xl">&times;</button></div>
            <div class="p-4 overflow-y-auto flex-grow"><table class="w-full text-left"><tbody id="stubbornList" class="text-sm"></tbody></table><div id="emptyStubbornMsg" class="text-center text-slate-400 py-10 hidden">æš‚æ— é¡½å›ºç”Ÿè¯ã€‚</div></div>
            <div class="p-4 border-t bg-slate-50 flex justify-between">
                <button onclick="exportExcel(stubbornNotebook, 'é¡½å›ºç”Ÿè¯æœ¬')" class="text-slate-800 font-bold text-sm hover:underline">ğŸ“¥ å¯¼å‡ºExcel</button>
                <div>
                    <button onclick="clearNotebook('stubborn')" class="text-red-500 text-xs mr-4 hover:underline">æ¸…ç©º</button>
                    <button onclick="toggleModal('stubbornModal')" class="bg-slate-200 px-4 py-2 rounded-lg text-sm font-bold">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[60vh] flex flex-col shadow-2xl">
            <div class="p-4 border-b bg-slate-50 rounded-t-2xl"><h3 class="font-bold text-lg text-slate-700">ğŸ“œ ä¸Šä¼ å†å²</h3></div>
            <div class="p-4 overflow-y-auto flex-grow"><ul id="historyList" class="space-y-2 text-sm text-slate-600"></ul></div>
            <div class="p-4 border-t text-center"><button onclick="toggleModal('historyModal')" class="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-bold">å…³é—­</button></div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒæ•°æ® ---
        let studyQueue = [];
        let originalQueue = []; // ç”¨äº"å†åˆ·ä¸€é"
        let currentSessionMistakes = []; // æœ¬æ¬¡ä¼šè¯çš„é”™é¢˜ï¼Œç”¨äºç»“ç®—é¡µé¢çš„"å¤ä¹ é”™é¢˜"
        let currentWord = null;
        let totalWords = 0;
        let currentIndex = 0;
        let wrongAttempts = 0;
        let isReviewMode = false; // æ˜¯å¦å¤„äº"å¤ä¹ é”™é¢˜"æ¨¡å¼

        // --- æŒä¹…åŒ–æ•°æ® ---
        let vocabNotebook = JSON.parse(localStorage.getItem('gina_vocab_notebook')) || [];
        let stubbornNotebook = JSON.parse(localStorage.getItem('gina_stubborn_notebook')) || [];
        let uploadHistory = JSON.parse(localStorage.getItem('gina_upload_history')) || [];

        // --- åˆå§‹åŒ– ---
        updateNotebookUI();
        updateStubbornUI();
        updateHistoryUI();
        checkSavedProgress();

        // --- å·¥å…·å‡½æ•° ---
        function normalize(str) {
            if (!str) return "";
            return str.toString().trim().replace(/[ãƒ¼ï¼â€”â€“-]/g, '-').replace(/\s+/g, '').toLowerCase();
        }

        function shuffle(a) { 
            let arr = [...a];
            for (let i = arr.length - 1; i > 0; i--) { 
                const j = Math.floor(Math.random() * (i + 1)); 
                [arr[i], arr[j]] = [arr[j], arr[i]]; 
            } 
            return arr; 
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }

        // --- å­˜æ¡£ä¸æ¢å¤é€»è¾‘ ---
        function checkSavedProgress() {
            const savedData = localStorage.getItem('gina_study_snapshot');
            if (savedData) {
                const snapshot = JSON.parse(savedData);
                document.getElementById('resumeBox').classList.remove('hidden-section');
                document.getElementById('resumeInfo').innerText = `åŒ…å« ${snapshot.queue.length} ä¸ªè¯ï¼Œè¿›åº¦: ${snapshot.index}`;
            }
        }

        function resumeStudy() {
            const snapshot = JSON.parse(localStorage.getItem('gina_study_snapshot'));
            studyQueue = snapshot.queue;
            originalQueue = [...snapshot.queue]; // ç®€æ˜“å¤„ç†ï¼Œæ¢å¤æ—¶é»˜è®¤åŸé˜Ÿåˆ—å³å½“å‰é˜Ÿåˆ—
            currentIndex = snapshot.index;
            totalWords = studyQueue.length;
            currentSessionMistakes = []; // æ¢å¤æ—¶ä¸ä¿ç•™æ—§çš„ä¼šè¯é”™é¢˜è®°å½•ï¼Œé‡æ–°è®¡ç®—
            startStudy();
        }

        function clearSavedProgress() {
            localStorage.removeItem('gina_study_snapshot');
            document.getElementById('resumeBox').classList.add('hidden-section');
        }

        function saveSnapshot() {
            // å¤ä¹ æ¨¡å¼ä¸å­˜æ¡£ï¼Œé¿å…é€»è¾‘å¤æ‚
            if (isReviewMode) return;
            const snapshot = { queue: studyQueue, index: currentIndex };
            localStorage.setItem('gina_study_snapshot', JSON.stringify(snapshot));
        }

        // --- æ–‡ä»¶å¤„ç† ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files.length) return;
            let allData = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!uploadHistory.includes(file.name)) uploadHistory.unshift(file.name);
                const data = await parseExcel(file);
                allData = allData.concat(data);
            }
            localStorage.setItem('gina_upload_history', JSON.stringify(uploadHistory.slice(0, 50)));
            updateHistoryUI();
            
            if (allData.length === 0) return;
            
            originalQueue = [...allData]; // ä¿å­˜åŸå§‹æ•°æ®ä¾›é‡ç½®ä½¿ç”¨
            studyQueue = shuffle(allData);
            totalWords = studyQueue.length;
            currentIndex = 0;
            currentSessionMistakes = [];
            isReviewMode = false;
            startStudy();
        });

        function parseExcel(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    let allSheetData = [];
                    workbook.SheetNames.forEach(name => {
                        const sheet = workbook.Sheets[name];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row[0] && row[1]) {
                                allSheetData.push({
                                    kanji: row[0].toString().trim(),
                                    kana: row[1].toString().trim(),
                                    meaning: row[2] ? row[2].toString().trim() : ""
                                });
                            }
                        }
                    });
                    resolve(allSheetData);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // --- æ ¸å¿ƒæµç¨‹ ---
        function startStudy() {
            document.getElementById('uploadSection').classList.add('hidden-section');
            document.getElementById('finishSection').classList.add('hidden-section');
            document.getElementById('studySection').classList.remove('hidden-section');
            document.getElementById('totalCount').innerText = totalWords;
            
            // UI çŠ¶æ€æ˜¾ç¤º
            const modeBanner = document.getElementById('modeBanner');
            if (isReviewMode) modeBanner.classList.remove('hidden-section');
            else modeBanner.classList.add('hidden-section');

            loadNextWord();
        }

        function loadNextWord() {
            // ç»“æŸåˆ¤æ–­
            if (currentIndex >= studyQueue.length) {
                showFinishScreen();
                return;
            }

            currentWord = studyQueue[currentIndex];
            wrongAttempts = 0;
            saveSnapshot();

            // UI æ›´æ–°
            document.getElementById('questionText').innerText = currentWord.meaning || "ï¼ˆæ— ä¸­æ–‡ï¼‰";
            document.getElementById('remainCount').innerText = currentIndex + 1;
            const progress = (currentIndex / totalWords) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('percentText').innerText = `${Math.round(progress)}%`;

            // è¾“å…¥æ¡†é‡ç½®
            document.getElementById('inputKana').value = '';
            document.getElementById('inputKanji').value = '';
            document.getElementById('inputKana').disabled = false;
            document.getElementById('inputKanji').disabled = true;
            document.getElementById('step1').classList.remove('opacity-50');
            document.getElementById('step2').classList.add('hidden-section');
            document.getElementById('feedback').innerText = '';
            document.getElementById('btnSubmit').classList.remove('hidden-section');
            document.getElementById('btnNext').classList.add('hidden-section');
            setTimeout(() => document.getElementById('inputKana').focus(), 50);
        }

        function checkAnswer() {
            const step2Visible = !document.getElementById('step2').classList.contains('hidden-section');
            if (!step2Visible) {
                if (normalize(document.getElementById('inputKana').value) === normalize(currentWord.kana)) {
                    document.getElementById('inputKana').disabled = true;
                    document.getElementById('step1').classList.add('opacity-50');
                    document.getElementById('step2').classList.remove('hidden-section');
                    document.getElementById('inputKanji').disabled = false;
                    document.getElementById('inputKanji').focus();
                    document.getElementById('feedback').innerText = "âœ“ è¯»éŸ³æ­£ç¡®";
                    document.getElementById('feedback').className = "text-center text-sm font-bold text-indigo-600";
                } else { handleWrong("è¯»éŸ³é”™è¯¯"); }
            } else {
                if (normalize(document.getElementById('inputKanji').value) === normalize(currentWord.kanji)) {
                    document.getElementById('inputKanji').disabled = true;
                    currentIndex++; 
                    saveSnapshot();
                    document.getElementById('btnSubmit').classList.add('hidden-section');
                    document.getElementById('btnNext').classList.remove('hidden-section').focus();
                    document.getElementById('feedback').innerText = "ğŸ‰ æ­£ç¡®ï¼";
                    document.getElementById('feedback').className = "text-center text-sm font-bold text-green-600";
                } else { handleWrong("å†™æ³•é”™è¯¯"); }
            }
        }

        function handleWrong(m) {
            wrongAttempts++;
            const f = document.getElementById('feedback');
            f.innerText = `âŒ ${m} (${wrongAttempts >= 3 ? currentWord.kana + ' / ' + currentWord.kanji : 'å†è¯•ä¸€æ¬¡'})`;
            f.className = "text-center text-sm font-bold text-red-500 animate-pulse";
            
            // é”™è¯¯å¤„ç†é€»è¾‘
            if (wrongAttempts === 3) {
                // 1. è®°å½•åˆ°å½“å‰ä¼šè¯é”™é¢˜æœ¬ (ç”¨äºç»“ç®—é¡µé¢çš„å¤ä¹ )
                if (!currentSessionMistakes.some(w => w.kanji === currentWord.kanji)) {
                    currentSessionMistakes.push(currentWord);
                }

                // 2. åŒºåˆ†æ¨¡å¼å½•å…¥æ°¸ä¹…ç”Ÿè¯æœ¬
                if (isReviewMode) {
                    // å¦‚æœæ˜¯åœ¨å¤ä¹ æ¨¡å¼ä¸‹åˆé”™äº† -> è¿›é¡½å›ºç”Ÿè¯æœ¬
                    if (!stubbornNotebook.some(i => i.kanji === currentWord.kanji)) {
                        stubbornNotebook.unshift(currentWord);
                        localStorage.setItem('gina_stubborn_notebook', JSON.stringify(stubbornNotebook));
                        updateStubbornUI();
                    }
                } else {
                    // æ™®é€šæ¨¡å¼ -> è¿›æ™®é€šç”Ÿè¯æœ¬
                    if (!vocabNotebook.some(i => i.kanji === currentWord.kanji)) {
                        vocabNotebook.unshift(currentWord);
                        localStorage.setItem('gina_vocab_notebook', JSON.stringify(vocabNotebook));
                        updateNotebookUI();
                    }
                }
            }
        }

        // --- ç»“ç®—é¡µé¢é€»è¾‘ ---
        function showFinishScreen() {
            document.getElementById('studySection').classList.add('hidden-section');
            document.getElementById('finishSection').classList.remove('hidden-section');
            
            // å¦‚æœæ˜¯æ™®é€šæ¨¡å¼å®Œæˆï¼Œæ¸…é™¤å­˜æ¡£
            if (!isReviewMode) clearSavedProgress();

            // æ›´æ–°é”™é¢˜å¤ä¹ æŒ‰é’®çŠ¶æ€
            const btnReview = document.getElementById('btnReviewMistakes');
            const countSpan = document.getElementById('sessionMistakeCount');
            countSpan.innerText = currentSessionMistakes.length;
            
            if (currentSessionMistakes.length > 0) {
                btnReview.disabled = false;
                btnReview.classList.remove('opacity-50', 'cursor-not-allowed');
                btnReview.innerText = `âš”ï¸ ç«‹å³å¤ä¹ æœ¬æ¬¡é”™é¢˜ (${currentSessionMistakes.length})`;
            } else {
                btnReview.disabled = true;
                btnReview.classList.add('opacity-50', 'cursor-not-allowed');
                btnReview.innerText = `ğŸ‘ æœ¬æ¬¡å…¨å¯¹ï¼Œæ— é¡»å¤ä¹ `;
            }
        }

        function restartCurrentSet() {
            studyQueue = shuffle([...originalQueue]); // é‡ç½®ä¸ºåŸå§‹é˜Ÿåˆ—å¹¶ä¹±åº
            currentIndex = 0;
            totalWords = studyQueue.length;
            currentSessionMistakes = [];
            isReviewMode = false;
            startStudy();
        }

        function startReviewMistakes() {
            if (currentSessionMistakes.length === 0) return;
            studyQueue = shuffle([...currentSessionMistakes]); // åªèƒŒé”™é¢˜
            currentIndex = 0;
            totalWords = studyQueue.length;
            // æ¸…ç©ºæœ¬æ¬¡é”™é¢˜è®°å½•ï¼Œå‡†å¤‡åœ¨å¤ä¹ æ¨¡å¼ä¸‹è®°å½•"é¡½å›ºé”™è¯¯"
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸æ¸…é™¤ originalQueueï¼Œä½†å¤ä¹ æ¨¡å¼ç»“æŸåé€šå¸¸å»ºè®®é‡æ–°é€‰æ–‡ä»¶æˆ–é‡ç½®
            isReviewMode = true; 
            startStudy();
        }

        // --- ç”Ÿè¯æœ¬ä¸å¯¼å‡ºé€»è¾‘ ---
        function updateNotebookUI() {
            renderList('notebookList', vocabNotebook, 'notebookCountNav', 'emptyNotebookMsg', 'normal');
        }

        function updateStubbornUI() {
            renderList('stubbornList', stubbornNotebook, 'stubbornCountNav', 'emptyStubbornMsg', 'stubborn');
        }

        function renderList(listId, data, countId, msgId, type) {
            const list = document.getElementById(listId);
            document.getElementById(countId).innerText = data.length;
            list.innerHTML = '';
            if (data.length === 0) document.getElementById(msgId).classList.remove('hidden');
            else {
                document.getElementById(msgId).classList.add('hidden');
                data.forEach((w, i) => {
                    const r = document.createElement('tr');
                    r.className = "border-b text-xs";
                    const btnClass = type === 'stubborn' ? "text-red-600" : "text-indigo-600";
                    r.innerHTML = `<td class="py-2 font-bold">${w.kanji}</td><td class="px-2">${w.kana}</td><td>${w.meaning}</td><td class="text-right"><button onclick="removeNB(${i}, '${type}')" class="${btnClass} font-bold">å·²æ–©æ€</button></td>`;
                    list.appendChild(r);
                });
            }
        }

        function removeNB(i, type) {
            if (!confirm('ç¡®å®šå·²ç»å®Œå…¨æŒæ¡äº†å—ï¼Ÿ')) return;
            if (type === 'normal') {
                vocabNotebook.splice(i, 1);
                localStorage.setItem('gina_vocab_notebook', JSON.stringify(vocabNotebook));
                updateNotebookUI();
            } else {
                stubbornNotebook.splice(i, 1);
                localStorage.setItem('gina_stubborn_notebook', JSON.stringify(stubbornNotebook));
                updateStubbornUI();
            }
        }

        function clearNotebook(type) {
            if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿ')) return;
            if (type === 'normal') {
                vocabNotebook = [];
                localStorage.setItem('gina_vocab_notebook', JSON.stringify(vocabNotebook));
                updateNotebookUI();
            } else {
                stubbornNotebook = [];
                localStorage.setItem('gina_stubborn_notebook', JSON.stringify(stubbornNotebook));
                updateStubbornUI();
            }
        }

        // --- å¯¼å‡ºåŠŸèƒ½ (Excel) ---
        function exportExcel(data, filename) {
            if (data.length === 0) { alert("ç”Ÿè¯æœ¬ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡ºï¼"); return; }
            
            // è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼ [[kanji, kana, meaning], ...]
            const sheetData = data.map(w => [w.kanji, w.kana, w.meaning]);
            
            // åˆ›å»º Worksheet
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Words");
            
            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function updateHistoryUI() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            if (!uploadHistory.length) list.innerHTML = '<li class="text-center text-slate-400">æš‚æ— </li>';
            else uploadHistory.forEach(h => { const li = document.createElement('li'); li.innerHTML = `ğŸ“œ ${h}`; list.appendChild(li); });
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { 
                document.getElementById('notebookModal').classList.add('hidden'); 
                document.getElementById('historyModal').classList.add('hidden');
                document.getElementById('stubbornModal').classList.add('hidden');
            }
            if (e.key === 'Enter') {
                if (document.getElementById('studySection').classList.contains('hidden-section')) return;
                const btnSubmit = document.getElementById('btnSubmit');
                if (!btnSubmit.classList.contains('hidden-section')) { checkAnswer(); e.preventDefault(); }
                else if (!document.getElementById('btnNext').classList.contains('hidden-section')) { loadNextWord(); e.preventDefault(); }
            }
        });
    </script>
</body>
</html>
