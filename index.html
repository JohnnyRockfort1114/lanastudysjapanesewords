<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gina çš„æ—¥è¯­æŒ‡æŒ¥éƒ¨ V5.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-section { display: none; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <nav class="bg-indigo-600 text-white p-4 shadow-lg flex justify-between items-center shrink-0 z-50">
        <div class="flex items-center space-x-2">
            <span class="font-black text-xl tracking-tighter cursor-pointer" onclick="goHome()">G-COMMANDER</span>
            <span class="text-[10px] bg-indigo-500 px-1.5 py-0.5 rounded">V5.1</span>
        </div>
        <div class="flex items-center space-x-4 text-sm font-bold">
            <button onclick="toggleModal('stubbornModal')" class="flex items-center space-x-1 hover:text-indigo-200">
                <span>â˜ ï¸ é¡½å›º</span><span id="stubbornCountNav" class="bg-slate-800 text-[10px] px-1.5 rounded-full ml-1">0</span>
            </button>
            <button onclick="toggleModal('notebookModal')" class="flex items-center space-x-1 hover:text-indigo-200">
                <span>ğŸ“• ç”Ÿè¯</span><span id="notebookCountNav" class="bg-white text-indigo-600 text-[10px] px-1.5 rounded-full ml-1">0</span>
            </button>
        </div>
    </nav>

    <main class="flex-grow relative flex flex-col items-center overflow-y-auto p-4 md:p-8">
        
        <div id="homeSection" class="w-full max-w-4xl space-y-8 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-8 rounded-[2rem] text-white shadow-xl flex flex-col justify-between">
                    <div>
                        <h4 class="text-indigo-100 text-xs font-black uppercase tracking-widest mb-1">JLPT 2026 Countdown</h4>
                        <div class="text-6xl font-black mb-2" id="countdownDays">---</div>
                        <p class="text-sm text-indigo-100 opacity-80">è·ç¦» 2026.07.05 èƒ½åŠ›è€ƒè¿˜å‰©</p>
                    </div>
                    <p class="mt-8 text-xs font-medium italic border-l-2 border-indigo-300 pl-3" id="randomQuote">æ‰§è¡Œç›®æ ‡ï¼Œè€Œä¸æ˜¯ä¸€ç›´åœ¨è®¡åˆ’ç›®æ ‡ã€‚</p>
                </div>

                <div class="bg-white p-8 rounded-[2rem] shadow-xl border border-slate-100 flex flex-col justify-center text-center">
                    <div id="resumeBox" class="hidden-section mb-6 p-4 bg-amber-50 border border-amber-100 rounded-2xl text-left">
                        <p id="resumeInfo" class="text-xs text-amber-600 font-bold mb-3"></p>
                        <button onclick="resumeStudy()" class="w-full bg-amber-500 text-white text-xs py-2 rounded-xl font-bold hover:bg-amber-600 transition shadow-lg">ç»§ç»­ä¸Šæ¬¡è¿›åº¦</button>
                    </div>

                    <label class="group cursor-pointer">
                        <div class="mx-auto h-16 w-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mb-4 text-2xl group-hover:scale-110 transition duration-300">ğŸ“‚</div>
                        <h3 class="text-xl font-black text-slate-800">å¼€å§‹æ–°ä¸€è½®è®­ç»ƒ</h3>
                        <p class="text-slate-400 text-xs mt-2 mb-6">ä¸Šä¼ ä½ çš„ 805 è¯ Excel</p>
                        <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls" multiple />
                        <span class="inline-block bg-indigo-600 text-white px-8 py-3 rounded-2xl font-black text-sm shadow-xl hover:bg-indigo-700 transition">æµè§ˆæ–‡ä»¶</span>
                    </label>
                </div>
            </div>

            <div class="bg-slate-800 text-slate-300 p-6 rounded-3xl flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="text-2xl">ğŸ§ </div>
                    <div class="text-xs">
                        <p class="font-bold text-white mb-1">ä»Šæ—¥ç­–ç•¥ï¼šå…ˆéš¾åæ˜“</p>
                        <p>å…ˆæŠŠé”™è¯¯çš„é¡½å›ºç”Ÿè¯è¿‡ä¸€éï¼Œå†å¼€å§‹èƒŒæ–°è¯ã€‚</p>
                    </div>
                </div>
                <button onclick="toggleModal('stubbornModal')" class="text-[10px] font-bold border border-slate-600 px-3 py-1 rounded-full hover:bg-slate-700">ç«‹åˆ»å‰å¾€</button>
            </div>
        </div>

        <div id="studySection" class="hidden-section w-full max-w-xl fade-in">
            <div class="mb-6 flex justify-between items-end">
                <div>
                    <span id="modeLabel" class="text-[10px] font-black text-indigo-500 uppercase tracking-widest bg-indigo-50 px-2 py-1 rounded">DEEP MODE</span>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-bold text-slate-400 uppercase"><span id="remainCount">0</span> / <span id="totalCount">0</span></p>
                    <div class="w-32 bg-slate-200 h-1.5 rounded-full mt-1 overflow-hidden">
                        <div id="progressBar" class="bg-indigo-500 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="cardMain" class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden min-h-[450px] flex flex-col relative border border-slate-50">
                <button onclick="openEditModal()" class="absolute top-6 right-6 text-slate-300 hover:text-indigo-500 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>

                <div class="p-10 text-center flex-grow flex flex-col justify-center">
                    <p class="text-[10px] font-bold text-slate-300 mb-2 uppercase tracking-tighter">Meaning / ä¸­æ–‡å«ä¹‰</p>
                    <h2 id="questionText" class="text-4xl font-black text-slate-800 leading-tight mb-8">...</h2>

                    <div id="inputArea" class="space-y-4 max-w-xs mx-auto w-full">
                        <div id="step1">
                            <input type="text" id="inputKana" class="w-full border-b-4 border-slate-100 py-3 text-2xl focus:outline-none focus:border-indigo-500 text-center placeholder-slate-200 font-bold transition-all" placeholder="è¾“å…¥å‡å" autocomplete="off">
                        </div>
                        <div id="step2" class="hidden-section">
                            <input type="text" id="inputKanji" class="w-full border-b-4 border-slate-100 py-3 text-2xl focus:outline-none focus:border-indigo-500 text-center placeholder-slate-200 font-bold transition-all" placeholder="è¾“å…¥æ±‰å­—" autocomplete="off">
                        </div>
                        <p id="feedback" class="text-xs font-bold min-h-[1.5rem] mt-4"></p>
                    </div>
                </div>

                <div class="p-6 bg-slate-50 border-t border-slate-100 flex space-x-3">
                    <button id="btnSubmit" onclick="checkAnswer()" class="flex-grow bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-lg transition transform active:scale-95">æäº¤éªŒè¯</button>
                    <button id="btnNext" onclick="loadNextWord()" class="hidden-section flex-grow bg-emerald-500 hover:bg-emerald-600 text-white font-black py-4 rounded-2xl shadow-lg transition">ä¸‹ä¸€ä¸ªè¯</button>
                </div>
            </div>
        </div>

        <div id="finishSection" class="hidden-section w-full max-w-md bg-white p-12 rounded-[3rem] shadow-2xl text-center fade-in">
            <div class="text-8xl mb-6">ğŸ¥‚</div>
            <h2 class="text-3xl font-black text-slate-800 mb-2">è¾›è‹¦äº†ï¼ŒGinaï¼</h2>
            <p class="text-slate-400 text-sm mb-10">ä½ åˆšæ‰æˆ˜èƒœäº† <span id="sessionMistakeCount" class="text-red-500 font-bold">0</span> ä¸ªé”™è¯¯ã€‚ç»§ç»­ä¿æŒç†æ€§ã€‚</p>
            <div class="space-y-4">
                <button id="btnReviewMistakes" onclick="startReviewMistakes()" class="w-full bg-amber-500 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-amber-600 transition">âš”ï¸ å¤ä¹ æœ¬æ¬¡é”™é¢˜</button>
                <button onclick="restartCurrentSet()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-indigo-700 transition">ğŸ”„ é‡æ–°æŒ‘æˆ˜æœ¬ç»„</button>
                <button onclick="goHome()" class="w-full bg-slate-100 text-slate-600 font-black py-4 rounded-2xl transition hover:bg-slate-200">ğŸ  è¿”å›é¦–é¡µ</button>
            </div>
        </div>
    </main>

    <div id="editModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-[2.5rem] w-full max-w-sm p-10 shadow-2xl">
            <h3 class="font-black text-xl mb-8">âœï¸ çº æ­£è¯æ¡</h3>
            <div class="space-y-5">
                <div><label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">å†™æ³• (Kanji)</label><input id="editKanji" class="w-full bg-slate-50 rounded-xl p-4 border-none focus:ring-2 focus:ring-indigo-500 font-bold"></div>
                <div><label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">å‡å (Kana)</label><input id="editKana" class="w-full bg-slate-50 rounded-xl p-4 border-none focus:ring-2 focus:ring-indigo-500 font-bold"></div>
                <div><label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">å«ä¹‰ (Meaning)</label><input id="editMeaning" class="w-full bg-slate-50 rounded-xl p-4 border-none focus:ring-2 focus:ring-indigo-500 font-bold"></div>
            </div>
            <div class="flex space-x-3 mt-10">
                <button onclick="saveEdit()" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg">ç¡®è®¤ä¿å­˜</button>
                <button onclick="toggleModal('editModal')" class="flex-1 bg-slate-100 text-slate-400 py-4 rounded-2xl font-black">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="notebookModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-[2.5rem] w-full max-w-2xl max-h-[85vh] flex flex-col shadow-2xl">
            <div class="p-8 border-b flex justify-between items-center bg-slate-50 rounded-t-[2.5rem]"><h3 class="font-black text-xl">ğŸ“• ç”Ÿè¯æœ¬</h3><button onclick="toggleModal('notebookModal')" class="text-slate-400 text-3xl font-light">&times;</button></div>
            <div class="p-6 overflow-y-auto flex-grow"><table class="w-full text-left"><tbody id="notebookList" class="text-sm"></tbody></table></div>
            <div class="p-6 border-t flex justify-between"><button onclick="exportExcel(vocabNotebook, 'Gina_Notebook')" class="text-indigo-600 font-black text-sm">ğŸ“¥ å¯¼å‡º Excel</button><button onclick="toggleModal('notebookModal')" class="bg-indigo-600 text-white px-8 py-3 rounded-2xl font-black">å®Œæˆ</button></div>
        </div>
    </div>

    <div id="stubbornModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-[2.5rem] w-full max-w-2xl max-h-[85vh] flex flex-col shadow-2xl border-4 border-slate-800">
            <div class="p-8 border-b bg-slate-800 text-white rounded-t-[2.2rem] flex justify-between"><h3 class="font-black text-xl">â˜ ï¸ é¡½å›ºåˆ†å­ä»“åº“</h3><button onclick="toggleModal('stubbornModal')" class="text-slate-400 text-3xl font-light">&times;</button></div>
            <div class="p-6 overflow-y-auto flex-grow"><table class="w-full text-left"><tbody id="stubbornList" class="text-sm"></tbody></table></div>
            <div class="p-6 border-t flex justify-between"><button onclick="exportExcel(stubbornNotebook, 'Gina_Stubborn')" class="text-slate-800 font-black text-sm">ğŸ“¥ å¯¼å‡º Excel</button><button onclick="toggleModal('stubbornModal')" class="bg-slate-800 text-white px-8 py-3 rounded-2xl font-black">å…³é—­</button></div>
        </div>
    </div>

    <script>
        // --- åˆå§‹åŒ–ä¸æ ¸å¿ƒé€»è¾‘ ---
        let studyQueue = [];
        let originalQueue = [];
        let currentSessionMistakes = [];
        let currentWord = null;
        let totalWords = 0;
        let currentIndex = 0;
        let wrongAttempts = 0;
        let isReviewMode = false;
        let wordPatches = JSON.parse(localStorage.getItem('gina_word_patches')) || {};
        let vocabNotebook = JSON.parse(localStorage.getItem('gina_vocab_notebook')) || [];
        let stubbornNotebook = JSON.parse(localStorage.getItem('gina_stubborn_notebook')) || [];

        const quotes = [
            "æ‰§è¡Œç›®æ ‡ï¼Œè€Œä¸æ˜¯ä¸€ç›´åœ¨è®¡åˆ’ç›®æ ‡ã€‚",
            "å…ˆéš¾åæ˜“ï¼Œå¤„ç†é—®é¢˜æŒ‰ç…§è¿™ä¸ªä¼˜å…ˆçº§æ¥è§£å†³ã€‚",
            "å±è”½æƒ…ç»ªçš„è¯¯å¯¼ï¼Œç”¨ç†æ€§æ¥çœ‹å¾…æ‰€æœ‰äº‹æƒ…ã€‚",
            "è¦æ‹…å¾—èµ·è´£ä»»äºŒå­—ã€‚",
            "ä¸è¦è´ªå›¾çœ¼å‰å°åˆ©ã€‚ä¸è¦è‡ªå‘ã€‚"
        ];

        // é¡µé¢åˆ‡æ¢ä¸å€’è®¡æ—¶
        window.onload = () => {
            updateCountdown();
            updateNotebookUI();
            updateStubbornUI();
            checkSavedProgress();
            document.getElementById('randomQuote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
        };

        function updateCountdown() {
            const now = new Date();
            const target = new Date('2026-07-05T00:00:00');
            const diff = target - now;
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            document.getElementById('countdownDays').innerText = days > 0 ? days : "è€ƒè¯•ä¸­!";
        }

        function goHome() {
            document.getElementById('homeSection').classList.remove('hidden-section');
            document.getElementById('studySection').classList.add('hidden-section');
            document.getElementById('finishSection').classList.add('hidden-section');
            checkSavedProgress();
        }

        function normalize(str) { return str ? str.toString().trim().replace(/[ãƒ¼ï¼â€”â€“-]/g, '-').replace(/\s+/g, '').toLowerCase() : ""; }

        function checkSavedProgress() {
            const s = localStorage.getItem('gina_study_snapshot');
            if (s) {
                const data = JSON.parse(s);
                document.getElementById('resumeBox').classList.remove('hidden-section');
                document.getElementById('resumeInfo').innerText = `ä¸Šæ¬¡è¿›åº¦: ${data.index}/${data.queue.length}`;
            } else {
                document.getElementById('resumeBox').classList.add('hidden-section');
            }
        }

        function resumeStudy() {
            const s = JSON.parse(localStorage.getItem('gina_study_snapshot'));
            studyQueue = s.queue; currentIndex = s.index; totalWords = studyQueue.length;
            startStudy();
        }

        function clearSavedProgress() { localStorage.removeItem('gina_study_snapshot'); checkSavedProgress(); }

        // æ–‡ä»¶å¤„ç†
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = e.target.files; if (!files.length) return;
            let allData = [];
            for (let file of files) {
                const data = await parseExcel(file);
                allData = allData.concat(data);
            }
            if (!allData.length) return;
            
            // è¡¥ä¸ä¿®æ­£
            allData = allData.map(w => {
                const patch = wordPatches[w.kanji];
                return patch ? { ...w, ...patch, originalKanji: w.kanji } : w;
            });

            originalQueue = [...allData];
            studyQueue = shuffle(allData);
            totalWords = studyQueue.length;
            currentIndex = 0;
            isReviewMode = false;
            startStudy();
        });

        function parseExcel(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    let list = [];
                    workbook.SheetNames.forEach(n => {
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[n], { header: 1 });
                        for (let i = 1; i < json.length; i++) {
                            const row = json[i];
                            if (row[0] || row[1]) {
                                list.push({ 
                                    kanji: String(row[0] || row[1]).trim(), 
                                    kana: String(row[1] || row[0]).trim(), 
                                    meaning: String(row[2] || "ï¼ˆæš‚æ— é‡Šä¹‰ï¼‰").trim() 
                                });
                            }
                        }
                    });
                    resolve(list);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function startStudy() {
            document.getElementById('homeSection').classList.add('hidden-section');
            document.getElementById('finishSection').classList.add('hidden-section');
            document.getElementById('studySection').classList.remove('hidden-section');
            document.getElementById('totalCount').innerText = totalWords;
            loadNextWord();
        }

        function loadNextWord() {
            if (currentIndex >= studyQueue.length) { showFinishScreen(); return; }
            currentWord = studyQueue[currentIndex];
            wrongAttempts = 0;
            saveSnapshot();

            // UI æ›´æ–°
            document.getElementById('questionText').innerText = currentWord.meaning;
            document.getElementById('remainCount').innerText = currentIndex + 1;
            const progress = (currentIndex / totalWords) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;

            document.getElementById('inputKana').value = '';
            document.getElementById('inputKanji').value = '';
            document.getElementById('inputKana').disabled = false;
            document.getElementById('step2').classList.add('hidden-section');
            document.getElementById('step1').classList.remove('opacity-50');
            document.getElementById('feedback').innerText = '';
            document.getElementById('btnSubmit').classList.remove('hidden-section');
            document.getElementById('btnNext').classList.add('hidden-section');
            
            setTimeout(() => document.getElementById('inputKana').focus(), 50);
        }

        function checkAnswer() {
            const kanaInput = normalize(document.getElementById('inputKana').value);
            const kanjiInput = normalize(document.getElementById('inputKanji').value);
            const step2Visible = !document.getElementById('step2').classList.contains('hidden-section');

            if (!step2Visible) {
                if (kanaInput === normalize(currentWord.kana)) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ±‰å­—ã€‚å¦‚æœæ²¡æœ‰ï¼Œç›´æ¥é€šè¿‡
                    if (normalize(currentWord.kanji) === normalize(currentWord.kana) || !currentWord.kanji) {
                        passWord();
                    } else {
                        document.getElementById('inputKana').disabled = true;
                        document.getElementById('step1').classList.add('opacity-50');
                        document.getElementById('step2').classList.remove('hidden-section');
                        document.getElementById('inputKanji').focus();
                        showFeedback("âœ“ è¯»éŸ³æ­£ç¡®ï¼Œè¾“å…¥å†™æ³•", "text-indigo-600");
                    }
                } else { handleWrong("è¯»éŸ³ä¸åŒ¹é…"); }
            } else {
                if (kanjiInput === normalize(currentWord.kanji)) {
                    passWord();
                } else { handleWrong("å†™æ³•ä¸åŒ¹é…"); }
            }
        }

        function passWord() {
            showFeedback("ğŸ‰ æ­£ç¡®", "text-emerald-500");
            currentIndex++;
            saveSnapshot();
            document.getElementById('btnSubmit').classList.add('hidden-section');
            document.getElementById('btnNext').classList.remove('hidden-section').focus();
        }

        function handleWrong(msg) {
            wrongAttempts++;
            showFeedback(`âŒ ${msg} (${wrongAttempts}/3)`, "text-red-500");
            if (wrongAttempts >= 3) {
                showFeedback(`ğŸ’¡ ç­”æ¡ˆ: ${currentWord.kana} / ${currentWord.kanji}`, "text-amber-500");
                if (!currentSessionMistakes.some(w => w.kanji === currentWord.kanji)) currentSessionMistakes.push(currentWord);
                recordError();
            }
        }

        function recordError() {
            let target = isReviewMode ? stubbornNotebook : vocabNotebook;
            if (!target.some(i => i.kanji === currentWord.kanji)) {
                target.unshift(currentWord);
                localStorage.setItem(isReviewMode ? 'gina_stubborn_notebook' : 'gina_vocab_notebook', JSON.stringify(target));
                updateNotebookUI(); updateStubbornUI();
            }
        }

        function showFeedback(text, colorClass) {
            const f = document.getElementById('feedback');
            f.innerText = text;
            f.className = `text-xs font-bold mt-4 ${colorClass}`;
        }

        // --- çº é”™åŠŸèƒ½ ---
        function openEditModal() {
            document.getElementById('editKanji').value = currentWord.kanji;
            document.getElementById('editKana').value = currentWord.kana;
            document.getElementById('editMeaning').value = currentWord.meaning;
            toggleModal('editModal');
        }

        function saveEdit() {
            const patch = { 
                kanji: document.getElementById('editKanji').value.trim(),
                kana: document.getElementById('editKana').value.trim(),
                meaning: document.getElementById('editMeaning').value.trim()
            };
            const key = currentWord.originalKanji || currentWord.kanji;
            wordPatches[key] = patch;
            localStorage.setItem('gina_word_patches', JSON.stringify(wordPatches));
            Object.assign(currentWord, patch);
            toggleModal('editModal');
            loadNextWord();
        }

        // --- UI æ›´æ–°ä¸å¯¼å‡º ---
        function showFinishScreen() {
            document.getElementById('studySection').classList.add('hidden-section');
            document.getElementById('finishSection').classList.remove('hidden-section');
            document.getElementById('sessionMistakeCount').innerText = currentSessionMistakes.length;
            if (!isReviewMode) clearSavedProgress();
        }

        function goHome() { location.reload(); }

        function restartCurrentSet() {
            studyQueue = shuffle([...originalQueue]);
            currentIndex = 0; totalWords = studyQueue.length;
            currentSessionMistakes = []; isReviewMode = false;
            startStudy();
        }

        function startReviewMistakes() {
            if (!currentSessionMistakes.length) return;
            studyQueue = shuffle([...currentSessionMistakes]);
            currentIndex = 0; totalWords = studyQueue.length;
            isReviewMode = true; startStudy();
        }

        function updateNotebookUI() { renderList('notebookList', vocabNotebook, 'notebookCountNav', 'normal'); }
        function updateStubbornUI() { renderList('stubbornList', stubbornNotebook, 'stubbornCountNav', 'stubborn'); }

        function renderList(id, data, navId, type) {
            document.getElementById(navId).innerText = data.length;
            const el = document.getElementById(id); el.innerHTML = '';
            data.forEach((w, i) => {
                const r = document.createElement('tr'); r.className = "border-b border-slate-50";
                r.innerHTML = `<td class="py-4 font-bold text-slate-800">${w.kanji}</td><td class="px-2 text-slate-500">${w.kana}</td><td class="text-slate-400 italic">${w.meaning}</td><td class="text-right"><button onclick="removeNB(${i}, '${type}')" class="text-indigo-600 font-bold hover:underline">æŒæ¡</button></td>`;
                el.appendChild(r);
            });
        }

        function removeNB(i, t) {
            if (t === 'normal') { vocabNotebook.splice(i, 1); localStorage.setItem('gina_vocab_notebook', JSON.stringify(vocabNotebook)); updateNotebookUI(); }
            else { stubbornNotebook.splice(i, 1); localStorage.setItem('gina_stubborn_notebook', JSON.stringify(stubbornNotebook)); updateStubbornUI(); }
        }

        function exportExcel(data, name) {
            const ws = XLSX.utils.aoa_to_sheet(data.map(w => [w.kanji, w.kana, w.meaning]));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, `${name}_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function saveSnapshot() { if (!isReviewMode && studyQueue.length) localStorage.setItem('gina_study_snapshot', JSON.stringify({ queue: studyQueue, index: currentIndex })); }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function shuffle(a) { let r = [...a]; for (let i = r.length - 1; i > 0; i--) { let j = Math.floor(Math.random() * (i + 1)); [r[i], r[j]] = [r[j], r[i]]; } return r; }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (!document.getElementById('studySection').classList.contains('hidden-section')) {
                    const btnSubmit = document.getElementById('btnSubmit');
                    if (!btnSubmit.classList.contains('hidden-section')) { checkAnswer(); e.preventDefault(); }
                    else { loadNextWord(); e.preventDefault(); }
                }
            }
        });
    </script>
</body>
</html>
