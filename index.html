<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-COMMANDER V5.3 | Gina ä¸“ç”¨ç¨³å¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .hidden-section { display: none; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <nav class="bg-indigo-600 text-white p-4 shadow-lg flex justify-between items-center shrink-0 z-50">
        <div class="flex items-center space-x-2">
            <span class="font-black text-xl tracking-tighter cursor-pointer" onclick="location.reload()">G-COMMANDER</span>
            <span class="text-[10px] bg-indigo-500 px-1.5 py-0.5 rounded">V5.3</span>
        </div>
        <div class="flex items-center space-x-4 text-sm font-bold">
            <button onclick="toggleModal('stubbornModal')" class="hover:text-indigo-200">â˜ ï¸ é¡½å›º <span id="stubbornCountNav">0</span></button>
            <button onclick="toggleModal('notebookModal')" class="hover:text-indigo-200">ğŸ“• ç”Ÿè¯ <span id="notebookCountNav">0</span></button>
        </div>
    </nav>

    <main class="flex-grow relative flex flex-col items-center overflow-y-auto p-4 md:p-8">
        <div id="homeSection" class="w-full max-w-4xl space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gradient-to-br from-indigo-600 to-violet-700 p-8 rounded-[2rem] text-white shadow-xl">
                    <h4 class="text-indigo-200 text-xs font-black mb-1">JLPT 2026 COUNTDOWN</h4>
                    <div class="text-6xl font-black mb-4" id="countdownDays">---</div>
                    <p class="text-sm italic border-l-2 border-indigo-400 pl-3">"æ‰§è¡Œç›®æ ‡ï¼Œå±è”½æƒ…ç»ªè¯¯å¯¼ã€‚"</p>
                </div>
                <div class="bg-white p-8 rounded-[2rem] shadow-xl flex flex-col justify-center text-center border">
                    <label class="cursor-pointer">
                        <div class="text-4xl mb-2">ğŸ“‚</div>
                        <h3 class="font-black text-slate-800">ä¸Šä¼  805 è¯è¡¨</h3>
                        <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls" />
                        <span class="mt-4 inline-block bg-indigo-600 text-white px-8 py-3 rounded-2xl font-black text-sm shadow-lg">å¼€å§‹æŒ‘æˆ˜</span>
                    </label>
                </div>
            </div>
        </div>

        <div id="studySection" class="hidden-section w-full max-w-xl">
            <div class="mb-4 flex justify-between items-end px-2">
                <span class="text-[10px] font-black text-indigo-500 bg-indigo-50 px-2 py-1 rounded">DEEP MEMORY MODE</span>
                <span class="text-[10px] font-bold text-slate-400"><span id="remainCount">0</span> / <span id="totalCount">0</span></span>
            </div>

            <div class="glass-card rounded-[2.5rem] shadow-2xl min-h-[420px] flex flex-col relative">
                <button onclick="openEditModal()" class="absolute top-6 right-6 text-slate-300 hover:text-indigo-500 transition">âœï¸</button>
                
                <div class="p-10 text-center flex-grow flex flex-col justify-center">
                    <span class="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-2 block">Meaning / é¢˜ç›®</span>
                    <h2 id="questionText" class="text-4xl font-black text-slate-800 leading-tight mb-8 min-h-[3rem]">...</h2>

                    <div class="space-y-4 max-w-xs mx-auto w-full">
                        <div id="step1">
                            <input type="text" id="inputKana" class="w-full border-b-4 border-slate-100 py-3 text-2xl focus:outline-none focus:border-indigo-500 text-center font-bold" placeholder="è¾“å…¥å‡å" autocomplete="off">
                        </div>
                        <div id="step2" class="hidden-section">
                            <input type="text" id="inputKanji" class="w-full border-b-4 border-slate-100 py-3 text-2xl focus:outline-none focus:border-indigo-500 text-center font-bold" placeholder="è¾“å…¥æ±‰å­—" autocomplete="off">
                        </div>
                        <p id="feedback" class="text-xs font-black mt-4 h-4"></p>
                    </div>
                </div>

                <div class="p-6 bg-slate-50 border-t rounded-b-[2.5rem] flex">
                    <button id="btnSubmit" onclick="checkAnswer()" class="flex-grow bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition">æäº¤éªŒè¯ (Enter)</button>
                    <button id="btnNext" onclick="loadNextWord()" class="hidden-section flex-grow bg-emerald-500 text-white font-black py-4 rounded-2xl shadow-lg">ä¸‹ä¸€å•è¯ (Enter)</button>
                </div>
            </div>
        </div>

        <div id="finishSection" class="hidden-section w-full max-w-md bg-white p-12 rounded-[3rem] shadow-2xl text-center">
            <h2 class="text-3xl font-black mb-10">ä»»åŠ¡æ‰§è¡Œå®Œæ¯•</h2>
            <button onclick="location.reload()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl">è¿”å›æŒ‡æŒ¥éƒ¨</button>
        </div>
    </main>

    <div id="editModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-[2.5rem] w-full max-w-sm p-8 shadow-2xl">
            <h3 class="font-black text-xl mb-6">âœï¸ ä¿®æ­£è¯æ¡</h3>
            <div class="space-y-4">
                <label class="text-[10px] font-bold text-slate-400 block mb-[-12px]">ä¸­æ–‡å«ä¹‰</label>
                <input id="editMeaning" class="w-full bg-slate-50 p-4 rounded-xl font-bold border">
                <label class="text-[10px] font-bold text-slate-400 block mb-[-12px]">å‡åè¯»éŸ³</label>
                <input id="editKana" class="w-full bg-slate-50 p-4 rounded-xl font-bold border">
                <label class="text-[10px] font-bold text-slate-400 block mb-[-12px]">æ±‰å­—å†™æ³•</label>
                <input id="editKanji" class="w-full bg-slate-50 p-4 rounded-xl font-bold border">
            </div>
            <div class="flex space-x-3 mt-8"><button onclick="saveEdit()" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-black">ä¿å­˜ä¿®æ”¹</button><button onclick="toggleModal('editModal')" class="flex-1 bg-slate-100 text-slate-400 py-4 rounded-2xl font-black">å–æ¶ˆ</button></div>
        </div>
    </div>

    <script>
        let studyQueue = [], currentIndex = 0, totalWords = 0, currentWord = null;
        let wordPatches = JSON.parse(localStorage.getItem('gina_word_patches')) || {};

        // å€’è®¡æ—¶
        function updateCountdown() {
            const days = Math.ceil((new Date('2026-07-05') - new Date()) / (1000*60*60*24));
            document.getElementById('countdownDays').innerText = days > 0 ? days : "Battle!";
        }
        window.onload = updateCountdown;

        // V5.3 æ ¸å¿ƒï¼šé²æ£’æ€§è¯»å–
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(ev) {
                const data = new Uint8Array(ev.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});

                let list = [];
                // è·³è¿‡ç¬¬ä¸€è¡Œæ ‡é¢˜ï¼Œä»ç¬¬äºŒè¡Œå¼€å§‹è¯»
                for(let i = 1; i < rows.length; i++) {
                    let row = rows[i];
                    if(!row || row.length < 2) continue;

                    // --- Gina è¯·æ³¨æ„ï¼šå¦‚æœè¯»å–è¿˜æ˜¯åçš„ï¼Œè¯·ä¿®æ”¹ä¸‹é¢çš„ [æ•°å­—] ---
                    // 0 ä»£è¡¨ A åˆ—ï¼Œ1 ä»£è¡¨ B åˆ—ï¼Œ2 ä»£è¡¨ C åˆ—ï¼Œä»¥æ­¤ç±»æ¨
                    let item = {
                        kanji: String(row[0] || "").trim(),    // å‡è®¾æ±‰å­—åœ¨ A åˆ—
                        kana: String(row[1] || "").trim(),     // å‡è®¾å‡ååœ¨ B åˆ—
                        meaning: String(row[2] || "").trim()   // å‡è®¾å«ä¹‰åœ¨ C åˆ—
                    };

                    // å¦‚æœå‘ç°æ•°æ®è¯»åäº†ï¼ˆæ¯”å¦‚ meaning è¿™ä¸€åˆ—å…¨æ˜¯å‡åï¼‰ï¼Œè¿™é‡Œåšä¸ªè‡ªåŠ¨äº¤æ¢
                    if (item.meaning.match(/^[ã-ã‚“ã‚¡-ãƒ¶ãƒ¼]+$/)) {
                        let temp = item.meaning;
                        item.meaning = item.kanji;
                        item.kanji = temp;
                    }
                    
                    // æè‡´ä¿åº•ï¼šå¦‚æœå«ä¹‰è¿˜æ˜¯ç©ºçš„ï¼Œæ‹¿è¿™ä¸€è¡Œæœ€é•¿çš„é‚£ä¸ªå•å…ƒæ ¼å½“é¢˜ç›®
                    if(!item.meaning) {
                        item.meaning = row.reduce((a, b) => String(a).length > String(b).length ? a : b);
                    }

                    if(wordPatches[item.kanji || item.kana]) Object.assign(item, wordPatches[item.kanji || item.kana]);
                    list.push(item);
                }
                studyQueue = list.sort(() => Math.random() - 0.5);
                totalWords = studyQueue.length;
                startStudy();
            };
            reader.readAsArrayBuffer(file);
        });

        function startStudy() {
            document.getElementById('homeSection').classList.add('hidden-section');
            document.getElementById('studySection').classList.remove('hidden-section');
            document.getElementById('totalCount').innerText = totalWords;
            loadNextWord();
        }

        function loadNextWord() {
            if (currentIndex >= studyQueue.length) {
                document.getElementById('studySection').classList.add('hidden-section');
                document.getElementById('finishSection').classList.remove('hidden-section');
                return;
            }
            currentWord = studyQueue[currentIndex];
            document.getElementById('questionText').innerText = currentWord.meaning;
            document.getElementById('remainCount').innerText = currentIndex + 1;
            document.getElementById('inputKana').value = '';
            document.getElementById('inputKanji').value = '';
            document.getElementById('step2').classList.add('hidden-section');
            document.getElementById('step1').classList.remove('opacity-50');
            document.getElementById('inputKana').disabled = false;
            document.getElementById('btnSubmit').classList.remove('hidden-section');
            document.getElementById('btnNext').classList.add('hidden-section');
            document.getElementById('feedback').innerText = '';
            setTimeout(() => document.getElementById('inputKana').focus(), 50);
        }

        function checkAnswer() {
            const kanaVal = document.getElementById('inputKana').value.trim().toLowerCase();
            const kanjiVal = document.getElementById('inputKanji').value.trim().toLowerCase();
            const isStep2 = !document.getElementById('step2').classList.contains('hidden-section');

            if (!isStep2) {
                if (kanaVal === currentWord.kana.toLowerCase()) {
                    if (!currentWord.kanji || currentWord.kanji === currentWord.kana) {
                        pass();
                    } else {
                        document.getElementById('step1').classList.add('opacity-50');
                        document.getElementById('inputKana').disabled = true;
                        document.getElementById('step2').classList.remove('hidden-section');
                        document.getElementById('inputKanji').focus();
                        document.getElementById('feedback').innerText = "âœ“ è¯»éŸ³æ­£ç¡®ï¼Œè¯·è¾“å…¥æ±‰å­—";
                        document.getElementById('feedback').className = "text-xs font-black mt-4 text-indigo-600";
                    }
                } else {
                    document.getElementById('feedback').innerText = `âŒ è¯»éŸ³é”™è¯¯ (æç¤º: ${currentWord.kana})`;
                    document.getElementById('feedback').className = "text-xs font-black mt-4 text-red-500";
                }
            } else {
                if (kanjiVal === currentWord.kanji.toLowerCase()) pass();
                else {
                    document.getElementById('feedback').innerText = `âŒ å†™æ³•é”™è¯¯ (æç¤º: ${currentWord.kanji})`;
                    document.getElementById('feedback').className = "text-xs font-black mt-4 text-red-500";
                }
            }
        }

        function pass() {
            document.getElementById('feedback').innerText = "ğŸ‰ æ­£ç¡®ï¼";
            document.getElementById('feedback').className = "text-xs font-black mt-4 text-emerald-500";
            document.getElementById('btnSubmit').classList.add('hidden-section');
            document.getElementById('btnNext').classList.remove('hidden-section').focus();
            currentIndex++;
        }

        function openEditModal() {
            document.getElementById('editMeaning').value = currentWord.meaning;
            document.getElementById('editKana').value = currentWord.kana;
            document.getElementById('editKanji').value = currentWord.kanji;
            toggleModal('editModal');
        }

        function saveEdit() {
            const p = {
                meaning: document.getElementById('editMeaning').value.trim(),
                kana: document.getElementById('editKana').value.trim(),
                kanji: document.getElementById('editKanji').value.trim()
            };
            wordPatches[currentWord.kanji || currentWord.kana] = p;
            localStorage.setItem('gina_word_patches', JSON.stringify(wordPatches));
            Object.assign(currentWord, p);
            toggleModal('editModal');
            loadNextWord();
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (!document.getElementById('btnNext').classList.contains('hidden-section')) loadNextWord();
                else checkAnswer();
            }
        });
    </script>
</body>
</html>
