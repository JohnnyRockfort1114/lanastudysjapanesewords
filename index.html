<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-COMMANDER V5.2 | ç¨³å®šä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-section { display: none; }
        .correct-flash { animation: flashGreen 0.5s; }
        @keyframes flashGreen { 0% { background: #ecfdf5; } 100% { background: white; } }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <nav class="bg-indigo-600 text-white p-4 shadow-lg flex justify-between items-center shrink-0 z-50">
        <div class="flex items-center space-x-2">
            <span class="font-black text-xl tracking-tighter cursor-pointer" onclick="location.reload()">G-COMMANDER</span>
            <span class="text-[10px] bg-indigo-500 px-1.5 py-0.5 rounded">V5.2</span>
        </div>
        <div class="flex items-center space-x-4 text-sm font-bold">
            <button onclick="toggleModal('stubbornModal')" class="hover:text-indigo-200">â˜ ï¸ é¡½å›º <span id="stubbornCountNav" class="bg-slate-800 px-1.5 rounded-full">0</span></button>
            <button onclick="toggleModal('notebookModal')" class="hover:text-indigo-200">ğŸ“• ç”Ÿè¯ <span id="notebookCountNav" class="bg-white text-indigo-600 px-1.5 rounded-full">0</span></button>
        </div>
    </nav>

    <main class="flex-grow relative flex flex-col items-center overflow-y-auto p-4 md:p-8">
        <div id="homeSection" class="w-full max-w-4xl space-y-6 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gradient-to-br from-indigo-600 to-violet-700 p-8 rounded-[2rem] text-white shadow-xl">
                    <h4 class="text-indigo-200 text-xs font-black uppercase tracking-widest mb-1">JLPT 2026 Countdown</h4>
                    <div class="text-6xl font-black mb-4" id="countdownDays">---</div>
                    <p class="text-sm opacity-80" id="randomQuote">æ‰§è¡Œç›®æ ‡ï¼Œå±è”½æƒ…ç»ªè¯¯å¯¼ã€‚</p>
                </div>
                <div class="bg-white p-8 rounded-[2rem] shadow-xl border border-slate-100 flex flex-col justify-center text-center">
                    <div id="resumeBox" class="hidden-section mb-4 p-4 bg-amber-50 rounded-2xl border border-amber-100">
                        <p id="resumeInfo" class="text-xs text-amber-700 font-bold mb-2"></p>
                        <button onclick="resumeStudy()" class="w-full bg-amber-500 text-white text-xs py-2 rounded-xl font-bold">ç»§ç»­ä¸Šæ¬¡</button>
                    </div>
                    <label class="cursor-pointer group">
                        <div class="mx-auto h-12 w-12 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition">ğŸ“‚</div>
                        <h3 class="font-black text-slate-800">å¯¼å…¥å•è¯è¡¨</h3>
                        <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls" />
                        <span class="mt-4 inline-block bg-indigo-600 text-white px-8 py-3 rounded-2xl font-black text-sm shadow-lg">æµè§ˆ Excel</span>
                    </label>
                </div>
            </div>
        </div>

        <div id="studySection" class="hidden-section w-full max-w-xl fade-in">
            <div class="mb-4 flex justify-between items-end px-2">
                <span class="text-[10px] font-black text-indigo-500 bg-indigo-50 px-2 py-1 rounded">DEEP MODE</span>
                <div class="text-right">
                    <span class="text-[10px] font-bold text-slate-400"><span id="remainCount">0</span> / <span id="totalCount">0</span></span>
                    <div class="w-24 bg-slate-200 h-1 rounded-full mt-1"><div id="progressBar" class="bg-indigo-500 h-full rounded-full transition-all" style="width: 0%"></div></div>
                </div>
            </div>

            <div id="cardMain" class="bg-white rounded-[2.5rem] shadow-2xl min-h-[420px] flex flex-col relative border border-slate-100">
                <button onclick="openEditModal()" class="absolute top-6 right-6 text-slate-200 hover:text-indigo-400 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                
                <div class="p-10 text-center flex-grow flex flex-col justify-center">
                    <span class="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-2 block">Meaning / é¢˜ç›®</span>
                    <h2 id="questionText" class="text-4xl font-black text-slate-800 leading-tight mb-8">åŠ è½½ä¸­...</h2>

                    <div class="space-y-4 max-w-xs mx-auto w-full">
                        <div id="step1">
                            <input type="text" id="inputKana" class="w-full border-b-4 border-slate-100 py-3 text-2xl focus:outline-none focus:border-indigo-500 text-center font-bold placeholder-slate-200" placeholder="è¾“å…¥å‡å" autocomplete="off">
                        </div>
                        <div id="step2" class="hidden-section">
                            <input type="text" id="inputKanji" class="w-full border-b-4 border-slate-100 py-3 text-2xl focus:outline-none focus:border-indigo-500 text-center font-bold placeholder-slate-200" placeholder="è¾“å…¥æ±‰å­—" autocomplete="off">
                        </div>
                        <p id="feedback" class="text-xs font-black h-4 mt-4"></p>
                    </div>
                </div>

                <div class="p-6 bg-slate-50 border-t rounded-b-[2.5rem] flex space-x-3">
                    <button id="btnSubmit" onclick="checkAnswer()" class="flex-grow bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition">æäº¤éªŒè¯ (Enter)</button>
                    <button id="btnNext" onclick="loadNextWord()" class="hidden-section flex-grow bg-emerald-500 text-white font-black py-4 rounded-2xl shadow-lg transition">ä¸‹ä¸€å•è¯ (Enter)</button>
                </div>
            </div>
        </div>

        <div id="finishSection" class="hidden-section w-full max-w-md bg-white p-12 rounded-[3rem] shadow-2xl text-center fade-in">
            <div class="text-7xl mb-6">ğŸ¯</div>
            <h2 class="text-3xl font-black mb-10">ä»Šæ—¥æ‰§è¡Œå®Œæ¯•</h2>
            <div class="space-y-4">
                <button onclick="startReviewMistakes()" class="w-full bg-amber-500 text-white font-black py-4 rounded-2xl shadow-lg">å¤ä¹ é”™é¢˜ (<span id="sessionMistakeCount">0</span>)</button>
                <button onclick="location.reload()" class="w-full bg-slate-100 text-slate-500 font-black py-4 rounded-2xl transition">è¿”å›é¦–é¡µ</button>
            </div>
        </div>
    </main>

    <div id="editModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-[2.5rem] w-full max-w-sm p-8 shadow-2xl">
            <h3 class="font-black text-xl mb-6">âœï¸ ä¿®æ­£è¯æ¡</h3>
            <div class="space-y-4">
                <input id="editMeaning" placeholder="å«ä¹‰" class="w-full bg-slate-50 p-4 rounded-xl border-none focus:ring-2 focus:ring-indigo-500 font-bold">
                <input id="editKana" placeholder="å‡å" class="w-full bg-slate-50 p-4 rounded-xl border-none focus:ring-2 focus:ring-indigo-500 font-bold">
                <input id="editKanji" placeholder="æ±‰å­—" class="w-full bg-slate-50 p-4 rounded-xl border-none focus:ring-2 focus:ring-indigo-500 font-bold">
            </div>
            <div class="flex space-x-3 mt-8"><button onclick="saveEdit()" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-black">ä¿å­˜</button><button onclick="toggleModal('editModal')" class="flex-1 bg-slate-100 text-slate-400 py-4 rounded-2xl font-black">å–æ¶ˆ</button></div>
        </div>
    </div>
    <div id="notebookModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 p-4 flex items-center justify-center">
        <div class="bg-white rounded-[2rem] w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl overflow-hidden"><div class="p-6 bg-slate-50 border-b font-black flex justify-between"><span>ğŸ“• ç”Ÿè¯æœ¬</span><button onclick="toggleModal('notebookModal')">&times;</button></div><div class="p-4 overflow-y-auto flex-grow"><table class="w-full text-left text-xs"><tbody id="notebookList"></tbody></table></div></div>
    </div>
    <div id="stubbornModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 p-4 flex items-center justify-center">
        <div class="bg-white rounded-[2rem] w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl border-4 border-slate-800 overflow-hidden"><div class="p-6 bg-slate-800 text-white font-black flex justify-between"><span>â˜ ï¸ é¡½å›ºåˆ†å­</span><button onclick="toggleModal('stubbornModal')">&times;</button></div><div class="p-4 overflow-y-auto flex-grow"><table class="w-full text-left text-xs"><tbody id="stubbornList"></tbody></table></div></div>
    </div>

    <script>
        let studyQueue = [], originalQueue = [], currentSessionMistakes = [], currentWord = null;
        let currentIndex = 0, totalWords = 0, wrongAttempts = 0, isReviewMode = false;
        
        let wordPatches = JSON.parse(localStorage.getItem('gina_word_patches')) || {};
        let vocabNotebook = JSON.parse(localStorage.getItem('gina_vocab_notebook')) || [];
        let stubbornNotebook = JSON.parse(localStorage.getItem('gina_stubborn_notebook')) || [];

        // åˆå§‹åŒ–
        window.onload = () => {
            updateCountdown();
            updateNotebookUI();
            updateStubbornUI();
            checkSavedProgress();
            document.getElementById('randomQuote').innerText = [
                "æ‰§è¡Œç›®æ ‡ï¼Œè€Œä¸æ˜¯ä¸€ç›´åœ¨è®¡åˆ’ç›®æ ‡ã€‚",
                "å…ˆéš¾åæ˜“ï¼Œå±è”½æƒ…ç»ªè¯¯å¯¼ã€‚",
                "è¦æ‹…å¾—èµ·è´£ä»»äºŒå­—ï¼Œè¦æœ‰å®è§‚çœ¼å…‰ã€‚"
            ][Math.floor(Math.random()*3)];
        };

        function updateCountdown() {
            const days = Math.ceil((new Date('2026-07-05') - new Date()) / (1000*60*60*24));
            document.getElementById('countdownDays').innerText = days > 0 ? days : "åŠ æ²¹!";
        }

        // æ–‡ä»¶è¯»å–é€»è¾‘ä¼˜åŒ– (V5.2 æ ¸å¿ƒ)
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const workbook = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (json.length < 2) return;

                // è‡ªåŠ¨è¯†åˆ«åˆ—ç´¢å¼•
                const header = json[0].map(h => String(h || "").toLowerCase());
                let kanjiIdx = header.findIndex(h => h.includes("æ±‰å­—") || h.includes("å†™æ³•") || h.includes("word") || h.includes("kanji"));
                let kanaIdx = header.findIndex(h => h.includes("å‡å") || h.includes("è¯»éŸ³") || h.includes("kana"));
                let meanIdx = header.findIndex(h => h.includes("å«ä¹‰") || h.includes("æ„æ€") || h.includes("ä¸­æ–‡") || h.includes("meaning"));

                // å¦‚æœæ²¡æ‰¾åˆ°è¡¨å¤´ï¼Œä½¿ç”¨ä¿å®ˆé»˜è®¤å€¼ (0:æ±‰å­—, 1:å‡å, 2:å«ä¹‰)
                if (kanjiIdx === -1) kanjiIdx = 0;
                if (kanaIdx === -1) kanaIdx = 1;
                if (meanIdx === -1) meanIdx = 2;

                let list = [];
                for (let i = 1; i < json.length; i++) {
                    const row = json[i];
                    if (!row[kanjiIdx] && !row[kanaIdx]) continue;
                    
                    let item = {
                        kanji: String(row[kanjiIdx] || "").trim(),
                        kana: String(row[kanaIdx] || "").trim(),
                        meaning: String(row[meanIdx] || "").trim()
                    };

                    // æå…¶é‡è¦çš„è¡¥æ•‘é€»è¾‘ï¼šå¦‚æœå«ä¹‰ä¸ºç©ºï¼Œå°è¯•ä»è¿™ä¸€è¡Œå…¶ä»–ä½ç½®æ‰¾å†…å®¹
                    if (!item.meaning) {
                        const otherContent = row.filter((c, idx) => idx !== kanjiIdx && idx !== kanaIdx && c);
                        item.meaning = otherContent.length > 0 ? String(otherContent[0]) : "æœªå®šä¹‰å«ä¹‰";
                    }

                    // åº”ç”¨æ‰‹åŠ¨è¡¥ä¸
                    if (wordPatches[item.kanji]) Object.assign(item, wordPatches[item.kanji]);
                    list.push(item);
                }

                originalQueue = [...list];
                studyQueue = shuffle(list);
                totalWords = studyQueue.length;
                currentIndex = 0;
                startStudy();
            };
            reader.readAsArrayBuffer(file);
        });

        function startStudy() {
            document.getElementById('homeSection').classList.add('hidden-section');
            document.getElementById('studySection').classList.remove('hidden-section');
            document.getElementById('finishSection').classList.add('hidden-section');
            document.getElementById('totalCount').innerText = totalWords;
            loadNextWord();
        }

        function loadNextWord() {
            if (currentIndex >= studyQueue.length) { showFinishScreen(); return; }
            currentWord = studyQueue[currentIndex];
            wrongAttempts = 0;
            saveSnapshot();

            // æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶æ¸²æŸ“å«ä¹‰æ ‡é¢˜
            const qEl = document.getElementById('questionText');
            qEl.innerText = currentWord.meaning || "ï¼ˆå«ä¹‰è§£æå¤±è´¥ï¼Œè¯·ç‚¹å‡»å³ä¸Šæ–¹çº é”™ï¼‰";
            
            document.getElementById('remainCount').innerText = currentIndex + 1;
            document.getElementById('progressBar').style.width = `${(currentIndex / totalWords) * 100}%`;
            document.getElementById('inputKana').value = '';
            document.getElementById('inputKanji').value = '';
            document.getElementById('inputKana').disabled = false;
            document.getElementById('step2').classList.add('hidden-section');
            document.getElementById('step1').classList.remove('opacity-50');
            document.getElementById('feedback').innerText = '';
            document.getElementById('btnSubmit').classList.remove('hidden-section');
            document.getElementById('btnNext').classList.add('hidden-section');
            
            setTimeout(() => document.getElementById('inputKana').focus(), 50);
        }

        function checkAnswer() {
            const kanaIn = normalize(document.getElementById('inputKana').value);
            const kanjiIn = normalize(document.getElementById('inputKanji').value);
            const isStep2 = !document.getElementById('step2').classList.contains('hidden-section');

            if (!isStep2) {
                if (kanaIn === normalize(currentWord.kana)) {
                    // å¦‚æœæ˜¯å’Œè¯­è¯ï¼ˆæ±‰å­—=å‡åï¼‰ï¼Œç›´æ¥è¿‡
                    if (!currentWord.kanji || normalize(currentWord.kanji) === normalize(currentWord.kana)) {
                        passWord();
                    } else {
                        document.getElementById('inputKana').disabled = true;
                        document.getElementById('step1').classList.add('opacity-50');
                        document.getElementById('step2').classList.remove('hidden-section');
                        document.getElementById('inputKanji').focus();
                        showFeedback("âœ“ è¯»éŸ³å¯¹ï¼Œè¾“å…¥æ±‰å­—", "text-indigo-600");
                    }
                } else { handleWrong("è¯»éŸ³é”™"); }
            } else {
                if (kanjiIn === normalize(currentWord.kanji)) passWord();
                else handleWrong("å†™æ³•é”™");
            }
        }

        function passWord() {
            document.getElementById('cardMain').classList.add('correct-flash');
            setTimeout(() => document.getElementById('cardMain').classList.remove('correct-flash'), 500);
            showFeedback("ğŸ‰ æ­£ç¡®", "text-emerald-500");
            currentIndex++;
            document.getElementById('btnSubmit').classList.add('hidden-section');
            document.getElementById('btnNext').classList.remove('hidden-section').focus();
        }

        function handleWrong(m) {
            wrongAttempts++;
            showFeedback(`âŒ ${m} (${wrongAttempts}/3)`, "text-red-500");
            if (wrongAttempts >= 3) {
                showFeedback(`ğŸ’¡ ${currentWord.kana} | ${currentWord.kanji}`, "text-amber-500");
                recordError();
            }
        }

        function recordError() {
            let target = isReviewMode ? stubbornNotebook : vocabNotebook;
            if (!target.some(i => i.kanji === currentWord.kanji)) {
                target.unshift(currentWord);
                localStorage.setItem(isReviewMode ? 'gina_stubborn_notebook' : 'gina_vocab_notebook', JSON.stringify(target));
                updateNotebookUI(); updateStubbornUI();
            }
            if (!currentSessionMistakes.some(w => w.kanji === currentWord.kanji)) currentSessionMistakes.push(currentWord);
        }

        function showFeedback(t, c) { const f = document.getElementById('feedback'); f.innerText = t; f.className = `text-xs font-black mt-4 ${c}`; }
        function openEditModal() { document.getElementById('editMeaning').value = currentWord.meaning; document.getElementById('editKana').value = currentWord.kana; document.getElementById('editKanji').value = currentWord.kanji; toggleModal('editModal'); }
        function saveEdit() {
            const p = { meaning: document.getElementById('editMeaning').value, kana: document.getElementById('editKana').value, kanji: document.getElementById('editKanji').value };
            wordPatches[currentWord.kanji || currentWord.kana] = p;
            localStorage.setItem('gina_word_patches', JSON.stringify(wordPatches));
            Object.assign(currentWord, p);
            toggleModal('editModal');
            loadNextWord();
        }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function normalize(s) { return s ? s.toString().trim().replace(/[ãƒ¼ï¼â€”â€“-]/g, '-').replace(/\s+/g, '').toLowerCase() : ""; }
        function shuffle(a) { let r = [...a]; for (let i = r.length - 1; i > 0; i--) { let j = Math.floor(Math.random() * (i + 1)); [r[i], r[j]] = [r[j], r[i]]; } return r; }
        function showFinishScreen() { document.getElementById('studySection').classList.add('hidden-section'); document.getElementById('finishSection').classList.remove('hidden-section'); document.getElementById('sessionMistakeCount').innerText = currentSessionMistakes.length; localStorage.removeItem('gina_study_snapshot'); }
        function saveSnapshot() { if (!isReviewMode && studyQueue.length) localStorage.setItem('gina_study_snapshot', JSON.stringify({ queue: studyQueue, index: currentIndex })); }
        function checkSavedProgress() { const s = localStorage.getItem('gina_study_snapshot'); if (s) { const d = JSON.parse(s); document.getElementById('resumeBox').classList.remove('hidden-section'); document.getElementById('resumeInfo').innerText = `ä¸Šæ¬¡è¿›åº¦: ${d.index}/${d.queue.length}`; } }
        function resumeStudy() { const d = JSON.parse(localStorage.getItem('gina_study_snapshot')); studyQueue = d.queue; currentIndex = d.index; totalWords = studyQueue.length; startStudy(); }
        function updateNotebookUI() { renderList('notebookList', vocabNotebook, 'notebookCountNav', 'normal'); }
        function updateStubbornUI() { renderList('stubbornList', stubbornNotebook, 'stubbornCountNav', 'stubborn'); }
        function renderList(id, data, navId, type) {
            document.getElementById(navId).innerText = data.length;
            const el = document.getElementById(id); el.innerHTML = '';
            data.forEach((w, i) => {
                const r = document.createElement('tr'); r.className = "border-b";
                r.innerHTML = `<td class="py-3 font-bold">${w.kanji}</td><td class="px-2">${w.kana}</td><td class="italic text-slate-400">${w.meaning}</td><td class="text-right"><button onclick="removeNB(${i}, '${type}')" class="text-indigo-600 font-bold">æŒæ¡</button></td>`;
                el.appendChild(r);
            });
        }
        function removeNB(i, t) {
            if (t === 'normal') { vocabNotebook.splice(i, 1); localStorage.setItem('gina_vocab_notebook', JSON.stringify(vocabNotebook)); updateNotebookUI(); }
            else { stubbornNotebook.splice(i, 1); localStorage.setItem('gina_stubborn_notebook', JSON.stringify(stubbornNotebook)); updateStubbornUI(); }
        }
        function startReviewMistakes() { if (!currentSessionMistakes.length) return; studyQueue = shuffle([...currentSessionMistakes]); currentIndex = 0; totalWords = studyQueue.length; isReviewMode = true; startStudy(); }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const btnNext = document.getElementById('btnNext');
                if (!btnNext.classList.contains('hidden-section')) loadNextWord();
                else if (!document.getElementById('studySection').classList.contains('hidden-section')) checkAnswer();
            }
        });
    </script>
</body>
</html>
